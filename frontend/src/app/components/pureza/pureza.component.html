<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isViewing ? 'Ver Pureza' : (isEditing ? 'Editar Pureza' : 'Crear Pureza') }}</h2>
    </ng-template>

    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas()">

      <div class="form-grid">
        <!-- Fecha -->
        <div class="form-field">
          <label for="fecha">Fecha Inia</label>
          <input id="fecha" type="date" [(ngModel)]="fechaInia" name="fecha" pInputText [readonly]="isReadonly" 
             [ngClass]="{ 'input-error': validarFecha(fechaInia) }"/>
          <span *ngIf="validarFecha(fechaInia)" class="error-message">La fecha no puede ser futura.</span>
        </div>
      </div>

      <!-- Tabla INIA -->
      <div class="table-section" style="margin: 2.5rem 0 3rem 0;">
        <h3 style="margin-bottom: 1rem; color: var(--azul); font-weight: 600;">Análisis INIA</h3>
        <div class="table-wrapper">
          <p-table 
            [value]="purezaTableRows" 
            [tableStyle]="{'width': '100%'}" 
            styleClass="p-datatable-gridlines rounded-table">
            <ng-template pTemplate="header">
            <tr>
              <th>Componente</th>
              <th>Gramos</th>
              <th>%</th>
              <th>% Redondeo</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
            <tr>
              <td><strong>{{ rowData.label }}</strong></td>
              <td>
                <div style="display: flex; flex-direction: column;">
                  <div>
                    <input 
                      type="number" 
                      [ngModel]="getGramosValue(rowIndex)"
                      (ngModelChange)="setGramosValue(rowIndex, $event)"
                      [name]="'gramos_' + rowIndex" 
                      pInputText 
                      [readonly]="isReadonly || rowIndex === 7"
                      [ngClass]="{ 'input-error': getGramosValue(rowIndex) != null && getGramosValue(rowIndex) < 0 }"/>
                    <span>g</span>
                  </div>

                  <span *ngIf="getGramosValue(rowIndex) != null && getGramosValue(rowIndex) < 0" class="error-message">Es negativo.</span>
                </div>
              </td>
              <td>
                <div *ngIf="rowIndex !== 0 && rowIndex !== 7">
                  <input 
                    type="number" 
                    [ngModel]="getPorcentajeValue(rowIndex)"
                    [name]="'porcentaje_' + rowIndex" 
                    pInputText 
                    [readonly]="true"
                  />
                  <span>%</span>
                </div>
                <div *ngIf="rowIndex === 0 || rowIndex === 7" class="empty-cell">
                  <!-- Sin porcentaje para peso inicial y peso total -->
                </div>
              </td>
              <td>
                <div *ngIf="rowIndex !== 0 && rowIndex !== 7">
                  <input 
                    type="number" 
                    [ngModel]="getPorcentajeRedondeoValue(rowIndex)"
                    (ngModelChange)="setPorcentajeRedondeoValue(rowIndex, $event)"
                    [name]="'porcentajeRedondeo_' + rowIndex" 
                    pInputText 
                    [readonly]="isReadonly"
                  />
                  <span>%</span>
                </div>
                <div *ngIf="rowIndex === 0 || rowIndex === 7" class="empty-cell">
                  <!-- Sin redondeo para peso inicial y peso total -->
                </div>
              </td>
            </tr>
          </ng-template>
          </p-table>
        </div>
      </div>

       <div class="form-grid">

        <div class="form-field">
          <label for="materiaInerteTipo">Tipo de Materia Inerte</label>
          <input id="materiaInerteTipo" type="text" [(ngModel)]="materiaInerteTipo" name="materiaInerteTipo" pInputText [readonly]="isReadonly" />
        </div>

        <!-- Fecha -->
        <div class="form-field">
          <label for="fecha">Fecha Inase</label>
          <input id="fecha" type="date" [(ngModel)]="fechaInase" name="fecha" pInputText [readonly]="isReadonly" [ngClass]="{ 'input-error': validarFecha(fechaInase) }"/>
          <span *ngIf="validarFecha(fechaInase)" class="error-message">La fecha no puede ser futura.</span>
        </div>
      </div>

      <!-- Tabla INASE -->
      <div class="table-section" style="margin: 2.5rem 0 3rem 0;">
        <h3 style="margin-bottom: 1rem; color: var(--azul); font-weight: 600;">Análisis INASE</h3>
        <div class="table-wrapper">
          <p-table 
            [value]="purezaTableRows" 
            [tableStyle]="{'width': '100%'}" 
            styleClass="p-datatable-gridlines rounded-table">
            <ng-template pTemplate="header">
            <tr>
              <th>Componente</th>
              <th>Gramos</th>
              <th>%</th>
              <th>% Redondeo</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
            <tr>
              <td><strong>{{ rowData.label }}</strong></td>
              <td>
                <div style="display: flex; flex-direction: column;">
                  <div>
                    <input 
                      type="number" 
                      [ngModel]="getGramosInaseValue(rowIndex)"
                      (ngModelChange)="setGramosInaseValue(rowIndex, $event)"
                      [name]="'gramosInase_' + rowIndex" 
                      pInputText 
                      [readonly]="isReadonly || rowIndex === 7"
                      [ngClass]="{ 'input-error': getGramosInaseValue(rowIndex) != null && getGramosInaseValue(rowIndex) < 0 }"/>
                    <span>g</span>
                  </div>
                  <span *ngIf="getGramosInaseValue(rowIndex) != null && getGramosInaseValue(rowIndex) < 0" class="error-message">Es negativo.</span>
                </div>
              </td>
              <td>
                <div *ngIf="rowIndex !== 0 && rowIndex !== 7">
                  <input 
                    type="number" 
                    [ngModel]="getPorcentajeInaseValue(rowIndex)"
                    [name]="'porcentajeInase_' + rowIndex" 
                    pInputText 
                    [readonly]="true"
                  />
                  <span>%</span>
                </div>
                <div *ngIf="rowIndex === 0 || rowIndex === 7" class="empty-cell">
                  <!-- Sin porcentaje para peso inicial y peso total -->
                </div>
              </td>
              <td>
                <div *ngIf="rowIndex !== 0 && rowIndex !== 7">
                  <input 
                    type="number" 
                    [ngModel]="getPorcentajeRedondeoInaseValue(rowIndex)"
                    (ngModelChange)="setPorcentajeRedondeoInaseValue(rowIndex, $event)"
                    [name]="'porcentajeRedondeoInase_' + rowIndex" 
                    pInputText 
                    [readonly]="isReadonly"
                  />
                  <span>%</span>
                </div>
                <div *ngIf="rowIndex === 0 || rowIndex === 7" class="empty-cell">
                  <!-- Sin redondeo para peso inicial y peso total -->
                </div>
              </td>
            </tr>
          </ng-template>
          </p-table>
        </div>
      </div>

      <div class="form-grid" style="margin-top: 3rem;">

        <div class="form-field">
          <label for="materiaInerteTipoInase">Tipo de Materia Inerte Inase</label>
          <input id="materiaInerteTipoInase" type="text" [(ngModel)]="materiaInerteTipoInase" name="materiaInerteTipoInase" pInputText [readonly]="isReadonly" />
        </div>

        <!-- Fecha estándar -->
        <div class="form-field">
          <label for="fechaEstandar">Fecha estándar</label>
          <input id="fechaEstandar" type="date" [(ngModel)]="fechaEstandar" name="fechaEstandar" pInputText [readonly]="isReadonly" 
            [ngClass]="{ 'input-error': validarFecha(fechaEstandar) }"/>
          <span *ngIf="validarFecha(fechaEstandar)" class="error-message">La fecha no puede ser futura.</span>
        </div>


        <!-- Multiselect Malezas tolerancia cero -->
        <div class="form-field">
          <label>Malezas tolerancia cero</label>
          <div class="custom-multiselect" [class.open]="isMalezasCeroDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasCeroDropdown()">
              <span class="selected-text">
                {{ getSelectedMalezasCeroText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasCeroDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasCeroDropdownOpen">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasCeroSearchText" name="malezasCeroSearch" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mc of getFilteredMalezasCero()" (click)="toggleMalezaCeroSelection(mc)" [class.selected]="isMalezaCeroSelected(mc.id)">
                  <input type="checkbox" [checked]="isMalezaCeroSelected(mc.id)" (change)="toggleMalezaCeroSelection(mc)" (click)="$event.stopPropagation()">
                  <span>{{ mc.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasCero().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Multiselect Malezas comunes -->
        <div class="form-field">
          <label>Malezas comunes</label>
          <div class="custom-multiselect" [class.open]="isMalezasComunesDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasComunesDropdown()">
              <span class="selected-text">
                {{ getSelectedMalezasComunesText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasComunesDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasComunesDropdownOpen">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasComunesSearchText" name="malezasComunesSearch" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let m of getFilteredMalezasComunes()" (click)="toggleMalezaComunSelection(m)" [class.selected]="isMalezaComunSelected(m.id)">
                  <input type="checkbox" [checked]="isMalezaComunSelected(m.id)" (change)="toggleMalezaComunSelection(m)" (click)="$event.stopPropagation()">
                  <span>{{ m.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasComunes().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Multiselect Malezas toleradas -->
        <div class="form-field">
          <label>Malezas toleradas</label>
          <div class="custom-multiselect" [class.open]="isMalezasToleradasDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasToleradasDropdown()">
              <span class="selected-text">
                {{ getSelectedMalezasToleradasText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasToleradasDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasToleradasDropdownOpen">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasToleradasSearchText" name="malezasToleradasSearch" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mt of getFilteredMalezasToleradas()" (click)="toggleMalezaToleradaSelection(mt)" [class.selected]="isMalezaToleradaSelected(mt.id)">
                  <input type="checkbox" [checked]="isMalezaToleradaSelected(mt.id)" (change)="toggleMalezaToleradaSelection(mt)" (click)="$event.stopPropagation()">
                  <span>{{ mt.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasToleradas().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Multiselect Otros cultivos -->
        <div class="form-field">
          <label>Otros cultivos</label>
          <div class="custom-multiselect" [class.open]="isCultivosDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleCultivosDropdown()">
              <span class="selected-text">
                {{ getSelectedCultivosText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isCultivosDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isCultivosDropdownOpen">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="cultivosSearchText" name="cultivosSearch" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let c of getFilteredCultivos()" (click)="toggleCultivoSelection(c)" [class.selected]="isCultivoSelected(c.id)">
                  <input type="checkbox" [checked]="isCultivoSelected(c.id)" (change)="toggleCultivoSelection(c)" (click)="$event.stopPropagation()">
                  <span>{{ c.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredCultivos().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Checkboxes mejorados -->
      <div class="checkbox-container" *ngIf="isEditing || isViewing">
        <h4 class="checkbox-title">{{ isViewing ? 'Opciones' : 'Opciones De Edición' }}</h4>
        <div class="checkbox-grid">
          <div class="checkbox-item">
            <input 
              type="checkbox" 
              id="estandar-checkbox"
              [(ngModel)]="estandar" 
              name="estandar"
              class="custom-checkbox"
              [disabled]="isReadonly"
            />
            <label for="estandar-checkbox" class="checkbox-label">
              <span class="checkmark"></span>
              <span class="checkbox-text">Estándar</span>
            </label>
          </div>
          
          <div class="checkbox-item">
            <input 
              type="checkbox" 
              id="repetido-checkbox"
              [(ngModel)]="repetido" 
              name="repetido"
              class="custom-checkbox"
              [disabled]="isReadonly"
            />
            <label for="repetido-checkbox" class="checkbox-label">
              <span class="checkmark"></span>
              <span class="checkbox-text">Repetir</span>
            </label>
          </div>
        </div>
      </div>

      <div *ngIf="errores.length > 0" class="error-container">
        <p class="error-message">
          {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
        </p>
        <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
      </div>

      <div class="submit-btn">
        <button
          *ngIf="!isViewing"
          pButton
          type="submit"
          [label]="isSubmitting ? 'Enviando...' : (isEditing ? 'Actualizar Pureza' : 'Crear Pureza')"
          class="p-button-success"
          [disabled]="isSubmitting"
        ></button>
        
        <button
          pButton
          type="button"
          (click)="onCancel()"
          [label]="isViewing ? 'Volver' : 'Cancelar'"
          class="p-button-secondary"
          style="margin-left: 10px;"
        ></button>
      </div>
    </form>
  </p-card>
</div>

