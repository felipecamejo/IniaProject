<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isViewing ? 'Ver DOSN' : (isEditing ? 'Editar DOSN' : 'Crear DOSN') }}</h2>
    </ng-template>

    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas();" >
  <!-- INASE Section -->
  <div class="section-title inase-title">INASE</div>
  <div class="form-grid inase-section">
        <div class="form-field">
          <label for="fechaInase">Fecha</label>
          <input id="fechaInase" type="date" [(ngModel)]="fechaInase" name="fechaInase" pInputText [readonly]="isReadonly" 
          [ngClass]="{ 'input-error': validarFecha(fechaInase) }"
          />
           <span *ngIf="validarFecha(fechaInase)" class="error-message">La fecha no puede ser futura.</span>
        </div>
        <div class="form-field">
          <label for="gramosInase">Gramos analizados</label>
          <input id="gramosInase" type="number" [(ngModel)]="gramosInase" name="gramosInase" pInputText [readonly]="isReadonly" 
          [ngClass]="{ 'input-error': !validarNumero(gramosInase) }"
          />
          <span *ngIf="!validarNumero(gramosInase)" class="error-message">El valor debe ser un número válido.</span>
        </div>
        <div class="form-field">
          <label for="tipoAnalisisInase">Tipo de análisis</label>
          <select id="tipoAnalisisInase" [(ngModel)]="tipoAnalisisInase" name="tipoAnalisisInase" pInputText [disabled]="isReadonly">
            <option value="Completo">Completo</option>
            <option value="Reducido">Reducido</option>
            <option value="Limitado">Limitado</option>
            <option value="Reducido - limitado">Reducido - limitado</option>
          </select>
        </div>
        <!-- Listados INASE -->
        <div class="form-field">
          <label>Malezas</label>
          <div class="custom-multiselect" [class.open]="isMalezasDropdownOpenInase" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasDropdownInase()">
              <span class="selected-text">
                {{ getSelectedMalezasTextInase() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasDropdownOpenInase"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasDropdownOpenInase">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasSearchTextInase" name="malezasSearchInase" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let m of getFilteredMalezasInase()" (click)="toggleMalezaSelectionInase(m)" [class.selected]="isMalezaSelectedInase(m.id)">
                  <input type="checkbox" [checked]="isMalezaSelectedInase(m.id)" (change)="toggleMalezaSelectionInase(m)" (click)="$event.stopPropagation()">
                  <span>{{ m.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasInase().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasInase.length">
            <div class="count-row" *ngFor="let id of selectedMalezasInase">
              <span class="count-label">{{ getLabelById(malezasOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasInaseCounts[id]" [name]="'malezaInaseCount_'+id" min="0" pInputText [readonly]="isReadonly" 
              [ngClass]="{ 'input-error': !validarNumero(malezasInaseCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Otros cultivos</label>
          <div class="custom-multiselect" [class.open]="isCultivosDropdownOpenInase" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleCultivosDropdownInase()">
              <span class="selected-text">
                {{ getSelectedCultivosTextInase() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isCultivosDropdownOpenInase"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isCultivosDropdownOpenInase">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="cultivosSearchTextInase" name="cultivosSearchInase" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let c of getFilteredCultivosInase()" (click)="toggleCultivoSelectionInase(c)" [class.selected]="isCultivoSelectedInase(c.id)">
                  <input type="checkbox" [checked]="isCultivoSelectedInase(c.id)" (change)="toggleCultivoSelectionInase(c)" (click)="$event.stopPropagation()">
                  <span>{{ c.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredCultivosInase().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedCultivosInase.length">
            <div class="count-row" *ngFor="let id of selectedCultivosInase">
              <span class="count-label">{{ getLabelById(cultivosOptions, id) }}</span>
              <input type="number" [(ngModel)]="cultivosInaseCounts[id]" [name]="'cultivoInaseCount_'+id" min="0" pInputText [readonly]="isReadonly" 
              [ngClass]="{ 'input-error': !validarNumero(cultivosInaseCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Malezas toleradas</label>
          <div class="custom-multiselect" [class.open]="isMalezasToleradasDropdownOpenInase" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasToleradasDropdownInase()">
              <span class="selected-text">
                {{ getSelectedMalezasToleradasTextInase() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasToleradasDropdownOpenInase"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasToleradasDropdownOpenInase">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasToleradasSearchTextInase" name="malezasToleradasSearchInase" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mt of getFilteredMalezasToleradasInase()" (click)="toggleMalezaToleradaSelectionInase(mt)" [class.selected]="isMalezaToleradaSelectedInase(mt.id)">
                  <input type="checkbox" [checked]="isMalezaToleradaSelectedInase(mt.id)" (change)="toggleMalezaToleradaSelectionInase(mt)" (click)="$event.stopPropagation()">
                  <span>{{ mt.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasToleradasInase().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasToleradasInase.length">
            <div class="count-row" *ngFor="let id of selectedMalezasToleradasInase">
              <span class="count-label">{{ getLabelById(malezasToleradasOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasToleradasInaseCounts[id]" [name]="'malezaTolInaseCount_'+id" min="0" pInputText [readonly]="isReadonly" 
              [ngClass]="{ 'input-error': !validarNumero(malezasToleradasInaseCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Malezas tolerancia cero</label>
          <div class="custom-multiselect" [class.open]="isMalezasCeroDropdownOpenInase" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasCeroDropdownInase()">
              <span class="selected-text">
                {{ getSelectedMalezasCeroTextInase() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasCeroDropdownOpenInase"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasCeroDropdownOpenInase">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasCeroSearchTextInase" name="malezasCeroSearchInase" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mc of getFilteredMalezasCeroInase()" (click)="toggleMalezaCeroSelectionInase(mc)" [class.selected]="isMalezaCeroSelectedInase(mc.id)">
                  <input type="checkbox" [checked]="isMalezaCeroSelectedInase(mc.id)" (change)="toggleMalezaCeroSelectionInase(mc)" (click)="$event.stopPropagation()">
                  <span>{{ mc.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasCeroInase().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasCeroInase.length">
            <div class="count-row" *ngFor="let id of selectedMalezasCeroInase">
              <span class="count-label">{{ getLabelById(malezasCeroOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasCeroInaseCounts[id]" [name]="'malezaCeroInaseCount_'+id" min="0" pInputText [readonly]="isReadonly" 
              [ngClass]="{ 'input-error': !validarNumero(malezasCeroInaseCounts[id]) }" />
            </div>
          </div>
        </div>
      </div>

  <!-- INIA Section -->
  <div class="section-title inia-title">INIA</div>
  <div class="form-grid inia-section">
        <div class="form-field">
          <label for="fechaInia">Fecha</label>
          <input id="fechaInia" type="date" [(ngModel)]="fechaInia" name="fechaInia" pInputText [readonly]="isReadonly" 
          [ngClass]="{ 'input-error': validarFecha(fechaInia) }"
          />
          <span *ngIf="validarFecha(fechaInia)" class="error-message">La fecha no puede ser futura.</span>
        </div>
        <div class="form-field">
          <label for="gramosInia">Gramos analizados</label>
          <input id="gramosInia" type="number" [(ngModel)]="gramosInia" name="gramosInia" pInputText [readonly]="isReadonly" 
          [ngClass]="{ 'input-error': !validarNumero(gramosInia) }"
          />
          <span *ngIf="!validarNumero(gramosInia)" class="error-message">El valor debe ser un número válido.</span>
        </div>
        <div class="form-field">
          <label for="tipoAnalisisInia">Tipo de análisis</label>
          <select id="tipoAnalisisInia" [(ngModel)]="tipoAnalisisInia" name="tipoAnalisisInia" pInputText [disabled]="isReadonly">
            <option value="Completo">Completo</option>
            <option value="Reducido">Reducido</option>
            <option value="Limitado">Limitado</option>
            <option value="Reducido - limitado">Reducido - limitado</option>
          </select>
        </div>
        <!-- Listados INIA -->
        <div class="form-field">
          <label>Malezas</label>
          <div class="custom-multiselect" [class.open]="isMalezasDropdownOpenInia" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasDropdownInia()">
              <span class="selected-text">
                {{ getSelectedMalezasTextInia() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasDropdownOpenInia"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasDropdownOpenInia">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasSearchTextInia" name="malezasSearchInia" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let m of getFilteredMalezasInia()" (click)="toggleMalezaSelectionInia(m)" [class.selected]="isMalezaSelectedInia(m.id)">
                  <input type="checkbox" [checked]="isMalezaSelectedInia(m.id)" (change)="toggleMalezaSelectionInia(m)" (click)="$event.stopPropagation()">
                  <span>{{ m.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasInia().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasInia.length">
            <div class="count-row" *ngFor="let id of selectedMalezasInia">
              <span class="count-label">{{ getLabelById(malezasOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasIniaCounts[id]" [name]="'malezaIniaCount_'+id" min="0" pInputText [readonly]="isReadonly" [ngClass]="{ 'input-error':!validarNumero(malezasIniaCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Otros cultivos</label>
          <div class="custom-multiselect" [class.open]="isCultivosDropdownOpenInia" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleCultivosDropdownInia()">
              <span class="selected-text">
                {{ getSelectedCultivosTextInia() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isCultivosDropdownOpenInia"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isCultivosDropdownOpenInia">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="cultivosSearchTextInia" name="cultivosSearchInia" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let c of getFilteredCultivosInia()" (click)="toggleCultivoSelectionInia(c)" [class.selected]="isCultivoSelectedInia(c.id)">
                  <input type="checkbox" [checked]="isCultivoSelectedInia(c.id)" (change)="toggleCultivoSelectionInia(c)" (click)="$event.stopPropagation()">
                  <span>{{ c.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredCultivosInia().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedCultivosInia.length">
            <div class="count-row" *ngFor="let id of selectedCultivosInia">
              <span class="count-label">{{ getLabelById(cultivosOptions, id) }}</span>
              <input type="number" [(ngModel)]="cultivosIniaCounts[id]" [name]="'cultivoIniaCount_'+id" min="0" pInputText [readonly]="isReadonly" [ngClass]="{ 'input-error':!validarNumero(cultivosIniaCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Malezas toleradas</label>
          <div class="custom-multiselect" [class.open]="isMalezasToleradasDropdownOpenInia" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasToleradasDropdownInia()">
              <span class="selected-text">
                {{ getSelectedMalezasToleradasTextInia() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasToleradasDropdownOpenInia"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasToleradasDropdownOpenInia">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasToleradasSearchTextInia" name="malezasToleradasSearchInia" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mt of getFilteredMalezasToleradasInia()" (click)="toggleMalezaToleradaSelectionInia(mt)" [class.selected]="isMalezaToleradaSelectedInia(mt.id)">
                  <input type="checkbox" [checked]="isMalezaToleradaSelectedInia(mt.id)" (change)="toggleMalezaToleradaSelectionInia(mt)" (click)="$event.stopPropagation()">
                  <span>{{ mt.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasToleradasInia().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasToleradasInia.length">
            <div class="count-row" *ngFor="let id of selectedMalezasToleradasInia">
              <span class="count-label">{{ getLabelById(malezasToleradasOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasToleradasIniaCounts[id]" [name]="'malezaTolIniaCount_'+id" min="0" pInputText [readonly]="isReadonly" [ngClass]="{ 'input-error':!validarNumero(malezasToleradasIniaCounts[id]) }" />
            </div>
          </div>
        </div>
        <div class="form-field">
          <label>Malezas tolerancia cero</label>
          <div class="custom-multiselect" [class.open]="isMalezasCeroDropdownOpenInia" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleMalezasCeroDropdownInia()">
              <span class="selected-text">
                {{ getSelectedMalezasCeroTextInia() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isMalezasCeroDropdownOpenInia"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isMalezasCeroDropdownOpenInia">
              <div class="multiselect-search">
                <input type="text" placeholder="Buscar..." [(ngModel)]="malezasCeroSearchTextInia" name="malezasCeroSearchInia" (click)="$event.stopPropagation()" class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" *ngFor="let mc of getFilteredMalezasCeroInia()" (click)="toggleMalezaCeroSelectionInia(mc)" [class.selected]="isMalezaCeroSelectedInia(mc.id)">
                  <input type="checkbox" [checked]="isMalezaCeroSelectedInia(mc.id)" (change)="toggleMalezaCeroSelectionInia(mc)" (click)="$event.stopPropagation()">
                  <span>{{ mc.label }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredMalezasCeroInia().length === 0">No se encontraron opciones</div>
              </div>
            </div>
          </div>
          <div class="selected-counts" *ngIf="selectedMalezasCeroInia.length">
            <div class="count-row" *ngFor="let id of selectedMalezasCeroInia">
              <span class="count-label">{{ getLabelById(malezasCeroOptions, id) }}</span>
              <input type="number" [(ngModel)]="malezasCeroIniaCounts[id]" [name]="'malezaCeroIniaCount_'+id" min="0" pInputText [readonly]="isReadonly" [ngClass]="{ 'input-error':!validarNumero(malezasCeroIniaCounts[id]) }" />
            </div>
          </div>
        </div>
  </div>

      <!-- Tabla de brassica y cuscuta spp. -->
      <div class="form-field">
        <label>Determinación de brassica y cuscuta spp.</label>
        <table class="brassica-cuscuta-table">
          <thead>
            <tr>
              <th>Especie</th>
              <th>¿Contiene?</th>
              <th *ngIf="brassicaCuscuta[0].contiene || brassicaCuscuta[1].contiene">Cantidad</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of brassicaCuscuta">
              <td>{{ item.label }}</td>
              <td>
                <select [(ngModel)]="item.contiene" [name]="'contiene_' + item.label" [disabled]="isReadonly">
                  <option [ngValue]="false">No contiene</option>
                  <option [ngValue]="true">Contiene</option>
                </select>
              </td>
              <td *ngIf="item.contiene">
                <input type="number" [(ngModel)]="item.gramos" [name]="'gramos_' + item.label" min="0" placeholder="Gramos" [readonly]="isReadonly" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Fecha estándar -->
      <div class="form-field" style="display: flex; flex-direction: column; align-items: flex-start;">
          <label for="fechaEstandar" style="margin-bottom: 0.25rem;">Fecha estándar</label>
          <input id="fechaEstandar" type="date" [(ngModel)]="fechaEstandar" name="fechaEstandar" pInputText [readonly]="isReadonly"
            [ngClass]="{ 'input-error': validarFecha(fechaEstandar) }"
            style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 0.25rem;" />
          <span *ngIf="validarFecha(fechaEstandar)" class="error-message">La fecha no puede ser futura.</span>
      </div>

      <!-- Checkboxes estándar y repetido (mutuamente excluyentes) - Solo visible para admin al editar -->
      <div class="form-field" style="display: flex; gap: 2rem;" *ngIf="isEditing && isAdmin">
        <div class="checkbox-item">
          <input 
            type="checkbox" 
            id="estandar-checkbox"
            [(ngModel)]="estandar" 
            (change)="onEstandarChange()"
            name="estandar"
            class="custom-checkbox"
            [disabled]="isReadonly || estandarDeshabilitado"
          />
          <label for="estandar-checkbox" class="checkbox-label">
            <span class="checkmark"></span>
            <span class="checkbox-text">Estándar</span>
          </label>
        </div>
        
        <div class="checkbox-item">
          <input 
            type="checkbox" 
            id="repetido-checkbox"
            [(ngModel)]="repetido" 
            (change)="onRepetidoChange()"
            name="repetido"
            class="custom-checkbox"
            [disabled]="isReadonly || repetidoDeshabilitado"
          />
          <label for="repetido-checkbox" class="checkbox-label">
            <span class="checkmark"></span>
            <span class="checkbox-text">Repetido</span>
          </label>
        </div>
      </div>

      <div *ngIf="errores.length > 0" class="error-container">
        <p class="error-message">
          {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
        </p>
        <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
      </div>

      <!-- Diálogo de confirmación para Estándar -->
      <app-confirm-dialog
        [visible]="mostrarConfirmEstandar"
        title="Confirmar análisis estándar"
        message="¿Estás seguro de que deseas marcar este análisis como estándar? Una vez marcado, no podrás cambiarlo."
        confirmText="Confirmar"
        cancelText="Cancelar"
        (confirm)="confirmarEstandar()"
        (cancel)="cancelarEstandar()">
      </app-confirm-dialog>

      <!-- Diálogo de confirmación para Repetido -->
      <app-confirm-dialog
        [visible]="mostrarConfirmRepetido"
        title="Confirmar análisis repetido"
        message="¿Estás seguro de que deseas marcar este análisis como repetido? Una vez marcado, no podrás cambiarlo."
        confirmText="Confirmar"
        cancelText="Cancelar"
        (confirm)="confirmarRepetido()"
        (cancel)="cancelarRepetido()">
      </app-confirm-dialog>


      <div class="submit-btn" style="display: flex; gap: 1rem;">
        <button
          *ngIf="!isViewing"
          pButton
          type="submit"
          [label]="isEditing ? 'Editar DOSN' : 'Crear DOSN'"
          class="p-button-success"
          [disabled]="errores.length > 0"
        ></button>
        <button
          pButton
          type="button"
          [label]="isViewing ? 'Volver' : 'Cancelar'"
          class="p-button-secondary"
          (click)="onCancel()"
        ></button>
      </div>
    </form>
  </p-card>
</div>
