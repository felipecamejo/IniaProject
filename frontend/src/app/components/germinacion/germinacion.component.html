<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isViewing ? 'Ver Germinación' : (isEditing ? 'Editar Germinación' : 'Crear Germinación') }}</h2>
    </ng-template>
    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas()">
      <!-- Tabla de fechas de conteo (solo una al inicio) adaptada a PrimeNG -->
      <div class="table-section" style="margin: 2.5rem 0 3rem 0;">
        <h3 style="margin-bottom: 1rem; color: var(--azul); font-weight: 600;">Fechas de conteo</h3>
          <div class="table-wrapper conteos-scroll" style="overflow-x:auto; min-width:400px;">
            <p-table [value]="[fechas]" [tableStyle]="{'min-width': (160 * (fechas.conteos.length + 3)) + 'px'}" styleClass="p-datatable-gridlines rounded-table conteos-min-width">
            <ng-template pTemplate="header">
              <tr>
                <th class="col-fecha">Inicio</th>
                <th *ngFor="let conteo of fechas.conteos; let i = index" class="col-fecha">Conteo {{i+1}}</th>
                <th class="col-fecha">Total de días</th>
                <th class="col-fecha">Acciones</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
              <tr>
                <td class="col-fecha">
                  <input type="date" [(ngModel)]="fechas.inicio" name="fechaInicio" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarFecha(fechas.inicio) }"
                  />
                </td>
                <ng-container *ngFor="let conteo of fechas.conteos; let i = index">
                  <td class="col-fecha">
                    <div class="col-fecha-flex">
                      <input type="date" [(ngModel)]="fechas.conteos[i]" [name]="'fechaConteo'+i" pInputText [readonly]="isReadonly" 
                      />
                      <button type="button" (click)="removeConteo(i)" style="margin-left:4px; color:#e11d48; background:none; border:none; font-size:1.2em; cursor:pointer;" *ngIf="fechas.conteos.length > 1 && !isReadonly">✕</button>
                    </div>
                  </td>
                </ng-container>
                <td class="col-fecha"><input type="number" [value]="fechas.totalDias" readonly pInputText class="calc-field"
                  [ngClass]="{ 'input-error':  validarNumeroNegativo(this.fechas.totalDias || 0) }"
                  /></td>
                <td class="col-fecha">
                  <button type="button" (click)="addConteo()" style="color:#2563eb; background:none; border:none; font-size:1.2em; cursor:pointer;" *ngIf="!isReadonly">+ Agregar conteo</button>
                </td>
              </tr>
            </ng-template>
          </p-table>
      </div>

      <!-- Select Tratamiento de semillas -->
      <div class="form-field" style="margin-bottom: 2.5rem; display: flex; flex-direction: column; align-items: flex-start;">
        <label for="tratamientoSemillas" style="font-weight:700; font-size:1.2em; margin-bottom:0.7rem; color:#1746a0; letter-spacing:0.5px;">Tipo de tratamiento de semillas</label>
        <select id="tratamientoSemillas" [(ngModel)]="tratamientoSemillas" (change)="onTratamientoChange()" name="tratamientoSemillas" [disabled]="isReadonly"
          style="padding:0.7rem 1.5rem; border-radius:12px; border:2px solid #2563eb; background:#f7fbff; font-size:1.15em; font-weight:600; color:#1746a0; box-shadow:0 2px 8px rgba(38,99,235,0.08); transition:border 0.2s;">
          <option value="sin curar">Sin curar</option>
          <option value="curada en planta">Curada en planta</option>
          <option value="curada en laboratorio">Curada en Laboratorio</option>
        </select>
        <span style="margin-top:0.7rem; color:#2563eb; font-weight:500; font-size:1em;">Elige el tratamiento para mostrar y editar su tabla correspondiente.</span>
      </div>

      <!-- Producto y dosis -->
      <div class="form-field" style="margin-bottom: 1.5rem; display: flex; align-items: center;">
        <label for="productoDosis" style="font-weight:600; margin-right:1rem;">Producto y dosis:</label>
        <input id="productoDosis" type="text" [(ngModel)]="productoDosis" name="productoDosis" pInputText [readonly]="isReadonly"
          placeholder="Ingrese producto y dosis..." />
      </div>

      <!-- Selects adicionales en una sola fila -->
      <div style="display: flex; flex-wrap: wrap; gap: 1.2rem; align-items: center; margin-bottom: 1.5rem;">
        <div class="form-field" style="margin-bottom: 0;">
          <label for="numSemillas" style="font-weight:600; margin-right:0.5rem;">Número de semillas por repetición:</label>
          <select id="numSemillas" [(ngModel)]="numSemillas" name="numSemillas" style="padding:0.4rem 1rem; border-radius:8px; border:1px solid #cbd5e1;">
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom: 0;">
          <label for="metodo" style="font-weight:600; margin-right:0.5rem;">Método:</label>
          <select id="metodo" [(ngModel)]="metodoId" name="metodoId" style="padding:0.4rem 1rem; border-radius:8px; border:1px solid #cbd5e1;">
            <option [ngValue]="null">Seleccione...</option>
            <option *ngFor="let m of metodos" [ngValue]="m.id">{{ m.nombre }}</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom: 0;">
          <label for="temperatura" style="font-weight:600; margin-right:0.5rem;">Temperatura:</label>
          <select id="temperatura" [(ngModel)]="temperatura" name="temperatura" style="padding:0.4rem 1rem; border-radius:8px; border:1px solid #cbd5e1;">
            <option value="15°C">15°C</option>
            <option value="20°C">20°C</option>
            <option value="25°C">25°C</option>
            <option value="20°C<==>30°C">20°C&lt;==&gt;30°C</option>
            <option value="15°C<==>30°C">15°C&lt;==&gt;30°C</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom: 0;">
          <label for="preFrio" style="font-weight:600; margin-right:0.5rem;">Pre-frío:</label>
          <select id="preFrio" [(ngModel)]="preFrio" name="preFrio" style="padding:0.4rem 1rem; border-radius:8px; border:1px solid #cbd5e1;">
            <option value="No">No</option>
            <option *ngFor="let d of diasPreFrio" [value]="d">{{d}}</option>
          </select>
            <div *ngIf="fechaSalidaPreFrio" style="margin-top:0.5rem; font-weight:600; color:#2563eb;">
              Fecha de salida de pre-frío: {{ fechaSalidaPreFrio }}
            </div>
                <div style="margin-top:0.5rem; font-weight:600; color:#1746a0;">
                  N° de Días: {{ numeroDias }}
                </div>
        </div>
        <div class="form-field" style="margin-bottom: 0;">
          <label for="preTratamiento" style="font-weight:600; margin-right:0.5rem;">Pre-tratamiento:</label>
          <select id="preTratamiento" [(ngModel)]="preTratamiento" name="preTratamiento" style="padding:0.4rem 1rem; border-radius:8px; border:1px solid #cbd5e1;">
            <option value="No">No</option>
            <option value="KNO3">KNO3</option>
            <option value="Pre-lavado">Pre-lavado</option>
            <option value="Pre-secado">Pre-secado</option>
            <option value="GA3">GA3</option>
          </select>
        </div>
      </div>
      <!-- Tabla de repeticiones para germinación adaptada a PrimeNG -->
      <div class="table-section" style="margin: 2.5rem 0 3rem 0;">
        <h3 style="margin-bottom: 1rem; color: var(--azul); font-weight: 600;">Repeticiones - Germinación</h3>
        <div class="table-wrapper conteos-scroll">
            <p-table [value]="repeticiones" [tableStyle]="{'min-width': '1000px'}" styleClass="p-datatable-gridlines rounded-table conteos-min-width">
            <ng-template pTemplate="header">
              <tr>
                  <th style="min-width:160px; width:160px;">Repetición</th>
                  <th *ngFor="let conteo of fechas.conteos; let i = index" style="min-width:160px; width:160px;">Normales {{i+1}}</th>
                  <th style="min-width:160px; width:160px;">Anormales</th>
                  <th style="min-width:160px; width:160px;">Duras</th>
                  <th style="min-width:160px; width:160px;">Frescas</th>
                  <th style="min-width:160px; width:160px;">Muertas</th>
                  <th style="min-width:160px; width:160px;">Total</th>
                  <th style="min-width:160px; width:160px;">Acciones</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rep let-rowIndex="rowIndex">
              <tr>
                <td style="min-width:160px; width:160px;">{{ rep.numero }}</td>
                <td *ngFor="let conteo of fechas.conteos; let n = index" style="min-width:160px; width:160px;">
                  <input type="number" [(ngModel)]="rep.normales[n]" [name]="'normales'+rowIndex+'_'+n" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(rep.normales[n]) }"/>
                </td>
                <td style="min-width:160px; width:160px;"><input type="number" [(ngModel)]="rep.anormales" [name]="'anormales'+rowIndex" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(rep.anormales) }"
                  /></td>
                <td style="min-width:160px; width:160px;">
                  <input type="number" [(ngModel)]="rep.duras" [name]="'duras'+rowIndex" pInputText  [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(rep.duras) }"
                  /></td>
                <td style="min-width:160px; width:160px;">
                  <input type="number" [(ngModel)]="rep.frescas" [name]="'frescas'+rowIndex" pInputText  [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(rep.frescas) }"
                  /></td>
                <td style="min-width:160px; width:160px;">
                  <input type="number" [(ngModel)]="rep.muertas" [name]="'muertas'+rowIndex" pInputText  [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(rep.muertas) }"
                  /></td>
                <td style="min-width:160px; width:160px;">
                  <input type="number" [value]="getTotal(rep)" readonly pInputText class="calc-field" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(getTotal(rep)) }"
                  />
                </td>
                <td style="min-width:160px; width:160px;">
                  <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="eliminarRepeticion(rowIndex)" [disabled]="repeticiones.length === 1"></button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td style="font-weight:bold; background:#f0f0f0;">Promedio sin redondeo</td>
                <td *ngFor="let conteo of fechas.conteos; let n = index">
                  <input type="number" [value]="getPromedioNormales(n)" readonly pInputText class="calc-field" 
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioNormales(n)) }"
                  />
                </td>
                <td>
                  <input type="number" [value]="getPromedioAnormales()" readonly pInputText class="calc-field"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioAnormales()) }"
                  />
                </td>
                <td>
                  <input type="number" [value]="getPromedioDuras()" readonly pInputText class="calc-field"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioDuras()) }"
                  />
                </td>
                <td>
                  <input type="number" [value]="getPromedioFrescas()" readonly pInputText class="calc-field"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioFrescas()) }"
                  />
                </td>
                <td>
                  <input type="number" [value]="getPromedioMuertas()" readonly pInputText class="calc-field" 
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioMuertas()) }"
                  />
                </td>
                <td>
                  <input type="number" [value]="getPromedioTotal()" readonly pInputText class="calc-field"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioTotal()) }"
                  />
                </td>
                <td style="background:#f0f0f0;"></td>
              </tr>
              <tr>
                <td style="font-weight:bold; background:#e0e7ff;">Promedio sin redondeo global</td>
                <td [attr.colspan]="fechas.conteos.length">
                  <input type="number" [value]="getPromedioNormalesGlobal()" readonly pInputText class="calc-field"  
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(getPromedioNormalesGlobal()) }"
                  />
                </td>
                <td colspan="6" style="background:#e0e7ff;"></td>
              </tr>
              <tr>
                <td style="font-weight:bold; background:#fffbe6;">Promedio redondeado</td>
                <td *ngFor="let conteo of fechas.conteos; let n = index">
                  <input type="number" [(ngModel)]="promedioManualNormales[n]" [name]="'promedioManualNormales'+n" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualNormales[n]) }"
                  />
                </td>
                <td>
                  <input type="number" [(ngModel)]="promedioManualAnormales" name="promedioManualAnormales" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualAnormales) }"
                  />
                </td>
                <td>
                  <input type="number" [(ngModel)]="promedioManualDuras" name="promedioManualDuras" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualDuras) }"
                  />
                </td>
                <td>
                  <input type="number" [(ngModel)]="promedioManualFrescas" name="promedioManualFrescas" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualFrescas) }"
                  />
                </td>
                <td>
                  <input type="number" [(ngModel)]="promedioManualMuertas" name="promedioManualMuertas" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualMuertas) }"
                  />
                </td>
                <td>
                  <input type="number" [(ngModel)]="promedioManualTotal" name="promedioManualTotal" pInputText [readonly]="isReadonly" class="user-input"
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(promedioManualTotal) }"
                  />
                </td>
                <td style="background:#fffbe6;"></td>
              </tr>
              <tr>
                <td style="font-weight:bold; background:#fef9c3;">%</td>
                <td [attr.colspan]="fechas.conteos.length">
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td>
                  <input type="number" [value]="''" readonly pInputText class="calc-field" />
                </td>
                <td style="background:#fef9c3;"></td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <button pButton type="button" label="Agregar repetición" class="btn-agregar-rep" (click)="agregarRepeticion()"></button>
      </div>

      <!-- Tabla INIA/INASE adaptada a PrimeNG, sin ngFor ni expresiones en ngModel -->
      <div class="table-section" style="margin: 2.5rem 0 3rem 0;">
        <h3 style="margin-bottom: 1rem; color: var(--azul); font-weight: 600;">Análisis INIA / INASE</h3>
        <div class="table-wrapper">
          <p-table [value]="[1,2]" [tableStyle]="{'width': '100%'}" styleClass="p-datatable-gridlines rounded-table">
            <ng-template pTemplate="header">
              <tr>
                <th></th>
                <th>P.Normales</th>
                <th>P.Anormales</th>
                <th>Duras</th>
                <th>Frescas</th>
                <th>Muertas</th>
                <th>Germinacion</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
              <tr *ngIf="row === 1">
                <td style="font-weight:bold;">INIA</td>
                <td>
                  <input type="number" [(ngModel)]="inia.pNormales" name="iniaPNormales" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(inia.pNormales) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inia.pAnormales" name="iniaPAnormales" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarPromedioNegativoOMayoraCiento(inia.pAnormales) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inia.duras" name="iniaDuras" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inia.duras) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inia.frescas" name="iniaFrescas" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inia.frescas) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inia.muertas" name="iniaMuertas" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inia.muertas) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inia.germinacion" name="iniaGerminacion" pInputText  [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inia.germinacion) }"
                  /></td>
              </tr>
              <tr *ngIf="row === 2">
                <td style="font-weight:bold;">INASE</td>
                <td>
                  <input type="number" [(ngModel)]="inase.pNormales" name="inasePNormales" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.pNormales) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inase.pAnormales" name="inasePAnormales" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.pAnormales) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inase.duras" name="inaseDuras" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.duras) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inase.frescas" name="inaseFrescas" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.frescas) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inase.muertas" name="inaseMuertas" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.muertas) }"
                  /></td>
                <td>
                  <input type="number" [(ngModel)]="inase.germinacion" name="inaseGerminacion" pInputText [readonly]="isReadonly" 
                  [ngClass]="{ 'input-error': validarNumeroNegativo(inase.germinacion) }"
                  /></td>
              </tr>
            </ng-template>
          </p-table>
      </div>


      <!-- Comentarios del analista -->
      <div class="form-field" style="margin-bottom: 2.5rem;">
        <label for="comentarios" style="font-weight:600; display:block; margin-bottom:0.5rem;">Comentarios:</label>
        <textarea id="comentarios" [(ngModel)]="comentarios" name="comentarios" rows="4" [readonly]="isReadonly" style="width:100%; max-width:700px; padding:0.7rem 1rem; border-radius:10px; border:2px solid #2563eb; background:#f7fbff; font-size:1.05em; color:#1746a0; resize:vertical; box-shadow:0 2px 8px rgba(38,99,235,0.08);"></textarea>
      </div>

      <div *ngIf="errores.length > 0" class="error-container">
        <p class="error-message">
          {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
        </p>
        <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
      </div>

      <div class="submit-btn" style="margin-top: 1.2rem; display: flex; gap: 1rem;" *ngIf="!isReadonly">
        <button
          pButton
          type="submit"
          [label]="isEditing ? 'Editar Germinacion' : 'Crear Germinacion'"
          class="p-button-success"
        ></button>
        <button
          pButton
          type="button"
          label="Cancelar"
          class="p-button-secondary"
          (click)="onCancel()"
        ></button>
      </div>
      
      <!-- Botón para modo visualización -->
      <div class="submit-btn" style="margin-top: 1.2rem; display: flex; gap: 1rem;" *ngIf="isReadonly">
        <button
          pButton
          type="button"
          label="Volver"
          class="p-button-secondary"
          (click)="onCancel()"
        ></button>
      </div>

  <!-- cierre correcto del form, sin duplicados -->
  <!-- cierre correcto del p-card, sin duplicados -->
</div>