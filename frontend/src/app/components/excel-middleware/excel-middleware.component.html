<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">Gestión de Excel - Middleware</h2>
    </ng-template>

    <!-- Verificación de permisos -->
    <div *ngIf="!canExportImport" class="mb-4">
      <p-message 
        severity="warn" 
        text="Solo los administradores y analistas pueden usar esta funcionalidad">
      </p-message>
    </div>

    <!-- Sección de Exportación -->
    <div class="section-export">
      <h3 class="section-title">
        <i class="pi pi-download"></i>
        Exportar Tablas a Excel
      </h3>
      <p class="section-description">
        Exporta todas las tablas de la base de datos a un archivo ZIP con archivos Excel.
        Puedes filtrar por análisis específicos o por rango de fechas.
      </p>

      <!-- Filtros de exportación -->
      <div class="filters-section">
        <h4 class="filters-title">Filtros de Exportación (Opcional)</h4>
        
        <div class="filter-row">
          <div class="filter-item">
            <label for="analisis-ids">IDs de Análisis</label>
            <input 
              type="text" 
              id="analisis-ids"
              pInputText
              [(ngModel)]="analisisIds" 
              placeholder="Ej: dosn:1,2,3;pureza:5,6"
              class="filter-input"
            />
            <small class="filter-help">Formato: tipo:id1,id2;tipo2:id3</small>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-item">
            <label for="fecha-desde">Fecha Desde</label>
            <input 
              type="date" 
              id="fecha-desde"
              [(ngModel)]="fechaDesde" 
              class="filter-input"
            />
          </div>
          <div class="filter-item">
            <label for="fecha-hasta">Fecha Hasta</label>
            <input 
              type="date" 
              id="fecha-hasta"
              [(ngModel)]="fechaHasta" 
              class="filter-input"
            />
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-item">
            <label for="campo-fecha">Campo de Fecha</label>
            <select 
              id="campo-fecha"
              [(ngModel)]="campoFecha" 
              class="filter-select"
            >
              <option *ngFor="let campo of camposFecha" [value]="campo.value">
                {{ campo.label }}
              </option>
            </select>
          </div>
          <div class="filter-item">
            <label for="formato">Formato</label>
            <select 
              id="formato"
              [(ngModel)]="formato" 
              class="filter-select"
            >
              <option *ngFor="let fmt of formatos" [value]="fmt.value">
                {{ fmt.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="filter-actions">
          <button 
            pButton 
            type="button" 
            label="Limpiar Filtros" 
            icon="pi pi-times"
            (click)="limpiarFiltros()"
            [disabled]="!tieneFiltros"
            class="p-button-secondary p-button-sm">
          </button>
        </div>
      </div>

      <div class="submit-btn">
          <p-button 
            [loading]="isExporting"
            [disabled]="!canExportImport || isExporting"
            (onClick)="exportarTablas()"
            styleClass="p-button-success">
            <span class="export-btn-content">
              <span class="pi pi-download"></span>
              <span>Exportar Tablas</span>
            </span>
          </p-button>
          <style>
            .export-btn-content {
              display: inline-flex;
              align-items: center;
              gap: 0.5em;
            }
          </style>
      </div>

      <!-- Resultado de la exportación -->
      <div *ngIf="exportResult" class="result-container">
        <div class="result-panel success-panel">
          <div class="result-header">
            <i class="pi pi-check-circle"></i>
            <strong>Exportación exitosa:</strong>
          </div>
          <pre class="result-pre">{{ exportResult }}</pre>
        </div>
      </div>

      <!-- Error de la exportación -->
      <div *ngIf="exportError" class="error-container">
        <div class="result-panel error-panel">
          <div class="result-header">
            <i class="pi pi-times-circle"></i>
            <strong>Error en la exportación:</strong>
          </div>
          <pre class="result-pre">{{ exportError }}</pre>
        </div>
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Sección de Importación -->
    <div class="section-import">
      <h3 class="section-title">
        <i class="pi pi-upload"></i>
        Importar Excel
      </h3>
      <p class="section-description">
        Importa datos desde uno o varios archivos Excel/CSV. Puedes seleccionar múltiples archivos a la vez. 
        El nombre del archivo determinará automáticamente la tabla destino.
      </p>
      <div class="example-box">
        <small>
          <strong>Ejemplo:</strong> Si el archivo se llama <code>usuarios.xlsx</code>, 
          los datos se importarán en la tabla <code>usuarios</code>
        </small>
      </div>

      <div class="file-upload-wrapper">
        <p-fileUpload
          mode="basic"
          accept=".xlsx,.xls,.csv"
          [multiple]="true"
          [auto]="false"
          [disabled]="!canExportImport || isImporting"
          (onSelect)="onFileSelect($event)"
          (onRemove)="onFileRemove()"
          chooseLabel="Seleccionar archivos Excel/CSV"
          [maxFileSize]="10000000">
        </p-fileUpload>
      </div>

      <div *ngIf="selectedFiles.length > 0" class="files-selected">
        <p class="files-header">
          <i class="pi pi-check-circle"></i>
          <strong>{{ selectedFiles.length === 1 ? 'Archivo seleccionado:' : 'Archivos seleccionados:' }}</strong>
        </p>
        <ul class="files-list">
          <li *ngFor="let file of selectedFiles">
            <i class="pi pi-file"></i>
            {{ file.name }} 
            <span class="file-size">({{ (file.size / 1024).toFixed(2) }} KB)</span>
          </li>
        </ul>
      </div>

      <div class="submit-btn">
          <p-button 
            [loading]="isImporting"
            [disabled]="!canExportImport || selectedFiles.length === 0 || isImporting"
            (onClick)="importarExcel()"
            styleClass="p-button-success">
            <span class="import-btn-content">
              <span class="pi pi-upload"></span>
              <span>{{ selectedFiles.length === 1 ? 'Importar Excel' : 'Importar Archivos' }}</span>
            </span>
          </p-button>
          <style>
            .import-btn-content {
              display: inline-flex;
              align-items: center;
              gap: 0.5em;
            }
          </style>
      </div>

      <!-- Resultado de la importación -->
      <div *ngIf="importResult" class="result-container">
        <div class="result-panel success-panel">
          <div class="result-header">
            <i class="pi pi-check-circle"></i>
            <strong>Importación exitosa:</strong>
          </div>
          <pre class="result-pre">{{ importResult }}</pre>
        </div>
      </div>

      <!-- Error de la importación -->
      <div *ngIf="importError" class="error-container">
        <div class="result-panel error-panel">
          <div class="result-header">
            <i class="pi pi-times-circle"></i>
            <strong>Error en la importación:</strong>
          </div>
          <pre class="result-pre">{{ importError }}</pre>
        </div>
      </div>
    </div>
  </p-card>
</div>

<p-toast></p-toast>
