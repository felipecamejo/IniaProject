<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isEditing ? 'Editar Pureza P. notatum' : 'Crear Pureza P. notatum' }}</h2>
    </ng-template>
    
    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas()">
      

      <!-- Tabla: Examen de semillas pura por corte -->
      <div class="table-section">
        <h3 class="table-title">Examen de semillas pura por corte</h3>
        <div class="table-wrapper">
          <table class="p-table">
            <thead>
              <tr>
                <th>Repetición</th>
                <th>N° semillas puras</th>
                <th>Peso (g)</th>
                <th>Semillas sanas (cant)</th>
                <th>Semillas sanas (g)</th>
                <th>Contaminadas y vanas (cant)</th>
                <th>Contaminadas y vanas (g)</th>
                <th>Control de pesos (g)</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="repeticiones.length === 0">
                <td colspan="9" class="no-repeticiones">
                  No hay repeticiones agregadas. Haz clic en "Agregar repetición" para comenzar.
                </td>
              </tr>
              <tr *ngFor="let rep of repeticiones; let i = index">
                <td>{{ i + 1 }}</td>
                <td><input type="number" [(ngModel)]="rep.nroSemillasPuras" name="nroSemillasPuras{{i}}" (ngModelChange)="onRepeticionChange(i, 'nroSemillasPuras', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.nroSemillasPuras != null && rep.nroSemillasPuras < 0 }"/></td>
                  
                
                <td><input type="number" [(ngModel)]="rep.peso" name="peso{{i}}" (ngModelChange)="onRepeticionChange(i, 'peso', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.peso != null && rep.peso < 0 }"/></td>
                  
                
                <td><input type="number" [(ngModel)]="rep.cantidadSemillasSanas" name="cantidadSemillasSanas{{i}}" (ngModelChange)="onRepeticionChange(i, 'cantidadSemillasSanas', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.cantidadSemillasSanas != null && rep.cantidadSemillasSanas < 0 }"/></td>
                  
                
                <td><input type="number" [(ngModel)]="rep.gramosSemillasSanas" name="gramosSemillasSanas{{i}}" (ngModelChange)="onRepeticionChange(i, 'gramosSemillasSanas', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.gramosSemillasSanas != null && rep.gramosSemillasSanas < 0 }"/></td>
                  

                <td><input type="number" [(ngModel)]="rep.contaminadasYVanas" name="contaminadasYVanas{{i}}" (ngModelChange)="onRepeticionChange(i, 'contaminadasYVanas', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.contaminadasYVanas != null && rep.contaminadasYVanas < 0 }"/></td>
                  

                <td><input type="number" [(ngModel)]="rep.gramosContaminadasYVanas" name="gramosContaminadasYVanas{{i}}" (ngModelChange)="onRepeticionChange(i, 'gramosContaminadasYVanas', $event)" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': rep.gramosContaminadasYVanas != null && rep.gramosContaminadasYVanas < 0 }"/></td>
                  
                <td>
                  <input
                    type="number"
                    [value]="getControlPesos(rep)"
                    name="controlPesos{{i}}"
                    [readonly]="true"
                    [ngClass]="{ 'input-error': getControlPesos(rep) != null && getControlPesos(rep) < 0 }"
                    pInputText
                  />
                </td>
                <td>
                  <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="eliminarRepeticion(i)" title="Eliminar" *ngIf="!isReadonly"></button>
                </td>
              </tr>
            </tbody>
          </table>
          <button pButton type="button" label="Agregar repetición" class="btn-agregar-rep" (click)="agregarRepeticion()" *ngIf="!isReadonly"></button>
        </div>
      </div>

      <div class="totales-wrapper" style="margin-top: 1.5rem; display: flex; gap: 3rem; justify-content: flex-start; align-items: center; background: #f6f6f6; border-radius: 8px; padding: 1rem 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-weight: 600; color: #2e7d32; font-size: 1.1em;">Peso total semillas analizadas:</span>
          <span style="font-size: 1.1em; color: #333;">{{ totalSemillasSanasPeso }} g</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-weight: 600; color: #c62828; font-size: 1.1em;">Peso total semillas contaminadas:</span>
          <span style="font-size: 1.1em; color: #333;">{{ totalSemillasContaminadasPeso }} g</span>
        </div>
      </div>
      <div class="porcentajes-wrapper" style="margin-top: 1.5rem; display: flex; gap: 3rem; justify-content: flex-start; align-items: center; background: #e3f2fd; border-radius: 8px; padding: 1rem 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-weight: 600; color: #1565c0; font-size: 1.1em;">A%:</span>
          <span style="font-size: 1.1em; color: #333;">--</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-weight: 600; color: #1565c0; font-size: 1.1em;">A% total:</span>
          <span style="font-size: 1.1em; color: #333;">--</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-weight: 600; color: #1565c0; font-size: 1.1em;">% semillas llenas y sanas:</span>
          <span style="font-size: 1.1em; color: #333;">--</span>
        </div>
      </div>

      <div class="table-section">
        <h3 class="table-title">% Pureza</h3>
        <div class="table-wrapper">
          <table class="p-table">
            <thead>
              <tr>
                <th></th>
                <th>Peso (g)</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Semilla pura</td>
                <td><input type="number" [(ngModel)]="semillaPuraGr" name="semillaPuraGr" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaPuraGr != null && semillaPuraGr < 0 }"/></td>
                  
                <td><input type="number" [(ngModel)]="semillaPuraPct" name="semillaPuraPct" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaPuraPct != null && (semillaPuraPct < 0 || semillaPuraPct > 100) }"/></td>
                
              </tr>
              <tr>
                <td>Semilla cultivos</td>
                <td><input type="number" [(ngModel)]="semillaCultivosGr" name="semillaCultivosGr" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaCultivosGr != null && semillaCultivosGr < 0 }"/></td>
                  
                <td><input type="number" [(ngModel)]="semillaCultivosPct" name="semillaCultivosPct" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaCultivosPct != null && (semillaCultivosPct < 0 || semillaCultivosPct > 100) }"/></td>
                  
              </tr>
              <tr>
                <td>Semilla malezas</td>
                <td><input type="number" [(ngModel)]="semillaMalezasGr" name="semillaMalezasGr" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaMalezasGr != null && semillaMalezasGr < 0 }"/></td>
                
                <td><input type="number" [(ngModel)]="semillaMalezasPct" name="semillaMalezasPct" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': semillaMalezasPct != null && (semillaMalezasPct < 0 || semillaMalezasPct > 100) }"/></td>
              </tr>
              <tr>
                <td>Materia inerte</td>
                <td><input type="number" [(ngModel)]="materiaInerteGr" name="materiaInerteGr" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': materiaInerteGr != null && materiaInerteGr < 0 }"/></td>
                  
                <td><input type="number" [(ngModel)]="materiaInertePct" name="materiaInertePct" [readonly]="isReadonly" pInputText 
                  [ngClass]="{ 'input-error': materiaInertePct != null && (materiaInertePct < 0 || materiaInertePct > 100) }"/></td>
                 
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="comentarios-wrapper" style="margin-top:2rem;">
        <label for="comentarios" style="font-weight:600; font-size:1.05em; color:#333;">Observaciones:</label>
        <textarea id="comentarios" [(ngModel)]="comentarios" name="comentarios" rows="4" [readonly]="isReadonly" style="width:100%; border-radius:8px; border:1px solid #bdbdbd; padding:0.75rem; font-size:1em; margin-top:0.5rem; resize:vertical;"></textarea>
      </div>

      <!-- Checkboxes -->
      <div class="checkbox-container" *ngIf="isEditing && !isReadonly">
        <h4 class="checkbox-title">Opciones De Edición</h4>
        <div class="checkbox-grid">
          <div class="checkbox-item">
            <input 
              type="checkbox" 
              id="estandar-checkbox"
              [(ngModel)]="estandar" 
              name="estandar"
              class="custom-checkbox"
            />
            <label for="estandar-checkbox" class="checkbox-label">
              <span class="checkmark"></span>
              <span class="checkbox-text">Estándar</span>
            </label>
          </div>

          <div class="checkbox-item">
            <input 
              type="checkbox" 
              id="repetido-checkbox"
              [(ngModel)]="repetido" 
              name="repetido"
              class="custom-checkbox"
            />
            <label for="repetido-checkbox" class="checkbox-label">
              <span class="checkmark"></span>
              <span class="checkbox-text">Repetir</span>
            </label>
          </div>
        </div>
      </div>

      <div *ngIf="errores.length > 0" class="error-container">
        <p class="error-message">
          {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
        </p>
        <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
      </div>

      <div class="submit-btn" style="display: flex; gap: 1rem; margin-top:2rem;">
        <button
          *ngIf="!isReadonly"
          pButton
          type="submit"
          [label]="isEditing ? 'Editar Pureza P. notatum' : 'Crear Pureza P. notatum'"
          class="p-button-success"
          [disabled]="errores.length > 0"
        ></button>
        <button
          pButton
          type="button"
          label="Cancelar"
          class="p-button-secondary"
          (click)="onCancel()"
        ></button>
      </div>
    </form>
  </p-card>
</div>
