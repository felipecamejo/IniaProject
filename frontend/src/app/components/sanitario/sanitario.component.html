<div class="container">
  <!-- Botón de navegación hacia atrás -->
  <button class="back-button" (click)="onCancel()">
    <i class="pi pi-arrow-left"></i>
  </button>
  
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isViewing ? 'Ver Sanitario' : (isEditing ? 'Editar Sanitario' : 'Crear Sanitario') }}</h2>
    </ng-template>

    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas()">
      <div class="form-grid">
        <!-- Campos de texto -->

        <div class="form-field">
          <label for="fechaSiembra">Fecha Siembra</label>
          <input 
            id="fechaSiembra" 
            type="date" 
            [(ngModel)]="fechaSiembra" 
            name="fechaSiembra" 
            pInputText 
            [readonly]="isReadonly" 
            [ngClass]="{ 'input-error': validarFecha(fechaSiembra) }"
            
          />
        </div>

        <div class="form-field">
          <label for="fecha">Fecha</label>
          <input id="fecha" type="date" [(ngModel)]="fecha" name="fecha" pInputText [readonly]="isReadonly"
            [ngClass]="{ 'input-error': validarFecha(fecha) }"
          />
        </div>

        <div class="form-field">
          <label for="metodo">Metodo</label>
          <input id="metodo" type="text" [(ngModel)]="metodo" name="metodo" pInputText [readonly]="isReadonly" />
        </div>

        <div class="form-field">
          <label for="temperatura">Temperatura</label>
          <input 
            id="temperatura" 
            type="number" 
            [(ngModel)]="temperatura" 
            name="temperatura" 
            pInputText 
            [readonly]="isReadonly"
            [ngClass]="{ 'input-error': !validarNumero(temperatura) }" 

          />
        </div>

        <div class="form-field">
          <label for="horasOscuridad">Horas Oscuridad</label>
          <input 
            id="horasOscuridad" 
            type="number" 
            [(ngModel)]="horasOscuridad" 
            name="horasOscuridad" 
            pInputText 
            [readonly]="isReadonly" 
            [ngClass]="{ 'input-error': !validarNumero(horasOscuridad) }" 
            
          />
        </div>

        <div class="form-field">
          <label for="horasLuz">Horas Luz</label>
          <input 
            id="horasLuz" 
            type="number" 
            [(ngModel)]="horasLuz" 
            name="horasLuz" 
            pInputText 
            [readonly]="isReadonly" 
            [ngClass]="{ 'input-error': !validarNumero(horasLuz) }" 

          />
        </div>

        <div class="form-field">
          <label for="numeroDias">Numero de Dias</label>
          <input 
            id="nroDias" 
            type="number" 
            [(ngModel)]="nroDias" 
            name="nroDias" 
            pInputText 
            [readonly]="isReadonly" 
            [ngClass]="{ 'input-error': !validarNumero(nroDias) }" 
            
          />
        </div>

        <div class="form-field">
          <label for="estado">Estado Producto y Dosis</label>
          <input id="estado" type="text" [(ngModel)]="estado" name="estado" pInputText [readonly]="isReadonly" />
        </div>

        <div class="form-field">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" rows="3" [(ngModel)]="observaciones" name="observaciones" pInputText [readonly]="isReadonly"></textarea>
        </div>

        <div class="form-field">
          <label for="numeroSemillasRepeticion">Numero de Semillas por Repeticion</label>
          <input 
            id="nroSemillasRepeticion" 
            type="number" 
            [(ngModel)]="nroSemillasRepeticion" 
            name="nroSemillasRepeticion" 
            pInputText 
            [readonly]="isReadonly" 
            (ngModelChange)="onNroSemillasRepeticionChange()"
            [ngClass]="{ 'input-error': !validarNumero(nroSemillasRepeticion) }"
          />
        </div>

        <div class="form-field">
          <label for="hongosSelect">Hongos Patógenos</label>
          <div class="custom-multiselect" [class.open]="isHongosDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleHongosDropdown()">
              <span class="selected-text">
                {{ getSelectedHongosText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isHongosDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isHongosDropdownOpen">
              <div class="multiselect-search">
                <input type="text" 
                       placeholder="Buscar hongos..." 
                       [(ngModel)]="hongosSearchText"
                       name="hongosSearch"
                       (click)="$event.stopPropagation()"
                       class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" 
                     *ngFor="let hongo of getFilteredHongos()" 
                     (click)="toggleHongoSelection(hongo)"
                     [class.selected]="isHongoSelected(hongo.id!)">
                  <input type="checkbox" 
                         [checked]="isHongoSelected(hongo.id!)"
                         (change)="toggleHongoSelection(hongo)"
                         (click)="$event.stopPropagation()">
                  <span>{{ hongo.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredHongos().length === 0">
                  No se encontraron hongos
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de hongos seleccionados -->
        <div *ngIf="hongosTable.length > 0">
          <h3 style="margin-top: 2rem;">Hongos Patógenos</h3>
          <div class="table-wrapper">
            <table class="p-table">
              <thead>
                <tr>
                  <th>Tipo Hongo</th>
                  <th>Repetición</th>
                  <th>Valor</th>
                  <th>% Incidencia</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let hongo of hongosTable; let i = index">
                  <td>{{ hongo.tipoHongo }}</td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosTable[i].repeticion" 
                      name="repeticion_{{i}}" 
                      placeholder="Repetición" 
                      [readonly]="isReadonly" 
                      [ngClass]="{ 'input-error': !validarNumero(hongosTable[i].repeticion) }"
                      
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosTable[i].valor" 
                      name="valor_{{i}}" 
                      placeholder="Valor" 
                      [readonly]="isReadonly" 
                      (ngModelChange)="onValorPatogenoChange(i)"
                      [ngClass]="{ 'input-error': !validarNumero(hongosTable[i].valor) }"
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosTable[i].incidencia" 
                      name="incidencia_{{i}}" 
                      placeholder="% Incidencia" 
                      min="0" 
                      max="100" 
                      [readonly]="true" 
                      
                    />
                    
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Hongos Contaminantes Campo -->
        <div class="form-field">
          <label for="hongosCampoSelect">Hongos Contaminantes Campo</label>
          <div class="custom-multiselect" [class.open]="isHongosCampoDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleHongosCampoDropdown()">
              <span class="selected-text">
                {{ getSelectedHongosCampoText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isHongosCampoDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isHongosCampoDropdownOpen">
              <div class="multiselect-search">
                <input type="text" 
                       placeholder="Buscar hongos..." 
                       [(ngModel)]="hongosCampoSearchText"
                       name="hongosCampoSearch"
                       (click)="$event.stopPropagation()"
                       class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" 
                     *ngFor="let hongo of getFilteredHongosCampo()" 
                     (click)="toggleHongoCampoSelection(hongo)"
                     [class.selected]="isHongoCampoSelected(hongo.id!)">
                  <input type="checkbox" 
                         [checked]="isHongoCampoSelected(hongo.id!)"
                         (change)="toggleHongoCampoSelection(hongo)"
                         (click)="$event.stopPropagation()">
                  <span>{{ hongo.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredHongosCampo().length === 0">
                  No se encontraron hongos
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de hongos contaminantes campo -->
        <div *ngIf="hongosCampoTable.length > 0">
          <h3 style="margin-top: 2rem;">Hongos Contaminantes Campo</h3>
          <div class="table-wrapper">
            <table class="p-table">
              <thead>
                <tr>
                  <th>Tipo Hongo</th>
                  <th>Repetición</th>
                  <th>Valor</th>
                  <th>% Incidencia</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let hongo of hongosCampoTable; let i = index">
                  <td>{{ hongo.tipoHongo }}</td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosCampoTable[i].repeticion" 
                      name="repeticionCampo_{{i}}"
                      placeholder="Repetición"
                      [readonly]="isReadonly"
                      [ngClass]="{ 'input-error': !validarNumero(hongosCampoTable[i].repeticion) }"
                      
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosCampoTable[i].valor" 
                      name="valorCampo_{{i}}" 
                      placeholder="Valor" 
                      [readonly]="isReadonly" 
                      (ngModelChange)="onValorContaminanteChange(i)"
                      [ngClass]="{ 'input-error': !validarNumero(hongosCampoTable[i].valor) }"
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosCampoTable[i].incidencia" 
                      name="incidenciaCampo_{{i}}" 
                      placeholder="% Incidencia" 
                      min="0" 
                      max="100" 
                      [readonly]="true" 
                      
                    />
                    
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Hongos Almacenaje -->
        <div class="form-field">
          <label for="hongosAlmacenajeSelect">Hongos Almacenaje</label>
          <div class="custom-multiselect" [class.open]="isHongosAlmacenajeDropdownOpen" [class.disabled]="isReadonly">
            <div class="multiselect-trigger" (click)="!isReadonly && toggleHongosAlmacenajeDropdown()">
              <span class="selected-text">
                {{ getSelectedHongosAlmacenajeText() }}
              </span>
              <i class="pi pi-chevron-down" [class.rotated]="isHongosAlmacenajeDropdownOpen"></i>
            </div>
            <div class="multiselect-dropdown" *ngIf="isHongosAlmacenajeDropdownOpen">
              <div class="multiselect-search">
                <input type="text" 
                       placeholder="Buscar hongos..." 
                       [(ngModel)]="hongosAlmacenajeSearchText"
                       name="hongosAlmacenajeSearch"
                       (click)="$event.stopPropagation()"
                       class="search-input">
                <i class="pi pi-search"></i>
              </div>
              <div class="multiselect-options-container">
                <div class="multiselect-option" 
                     *ngFor="let hongo of getFilteredHongosAlmacenaje()" 
                     (click)="toggleHongoAlmacenajeSelection(hongo)"
                     [class.selected]="isHongoAlmacenajeSelected(hongo.id!)">
                  <input type="checkbox" 
                         [checked]="isHongoAlmacenajeSelected(hongo.id!)"
                         (change)="toggleHongoAlmacenajeSelection(hongo)"
                         (click)="$event.stopPropagation()">
                  <span>{{ hongo.nombre }}</span>
                </div>
                <div class="no-results" *ngIf="getFilteredHongosAlmacenaje().length === 0">
                  No se encontraron hongos
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de hongos almacenaje -->
        <div *ngIf="hongosAlmacenajeTable.length > 0">
          <h3 style="margin-top: 2rem;">Hongos Almacenaje</h3>
          <div class="table-wrapper">
            <table class="p-table">
              <thead>
                <tr>
                  <th>Tipo Hongo</th>
                  <th>Repetición</th>
                  <th>Valor</th>
                  <th>% Incidencia</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let hongo of hongosAlmacenajeTable; let i = index">
                  <td>{{ hongo.tipoHongo }}</td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosAlmacenajeTable[i].repeticion" 
                      name="repeticionAlmacenaje_{{i}}" 
                      placeholder="Repetición" 
                      [readonly]="isReadonly" 
                      [ngClass]="{ 'input-error': !validarNumero(hongosAlmacenajeTable[i].repeticion) }"
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosAlmacenajeTable[i].valor" 
                      name="valorAlmacenaje_{{i}}" 
                      placeholder="Valor" 
                      [readonly]="isReadonly" 
                      (ngModelChange)="onValorAlmacenajeChange(i)"
                      [ngClass]="{ 'input-error': !validarNumero(hongosAlmacenajeTable[i].valor) }"
                    />
                    
                  </td>
                  <td>
                    <input 
                      type="number" 
                      [(ngModel)]="hongosAlmacenajeTable[i].incidencia" 
                      name="incidenciaAlmacenaje_{{i}}" 
                      placeholder="% Incidencia" 
                      min="0" 
                      max="100"
                      [readonly]="true"
                      
                    />
                    
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Checkboxes - visible solo para admin al editar -->
        <div class="checkbox-container" *ngIf="isEditing && isAdmin">
          <h4 class="checkbox-title">Opciones De Edición</h4>
          <div class="checkbox-grid">
            <div class="checkbox-item">
              <input 
                type="checkbox" 
                id="repetido-checkbox"
                [(ngModel)]="repetido" 
                (change)="onRepetidoChange()"
                name="repetido"
                class="custom-checkbox"
                [disabled]="isReadonly || repetidoDeshabilitado"
              />
              <label for="repetido-checkbox" class="checkbox-label">
                <span class="checkmark"></span>
                <span class="checkbox-text">Repetir</span>
              </label>
            </div>
            
            <div class="checkbox-item">
              <input 
                type="checkbox" 
                id="estandar-checkbox"
                [(ngModel)]="estandar" 
                (change)="onEstandarChange()"
                name="estandar"
                class="custom-checkbox"
                [disabled]="isReadonly || estandarDeshabilitado"
              />
              <label for="estandar-checkbox" class="checkbox-label">
                <span class="checkmark"></span>
                <span class="checkbox-text">Estándar</span>
              </label>
            </div>
          </div>
        </div>

        <div *ngIf="errores.length > 0" class="error-container">
          <p class="error-message">
            {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
          </p>
          <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
        </div>

        <!-- Diálogo de confirmación para Estándar -->
        <app-confirm-dialog
          [visible]="mostrarConfirmEstandar"
          title="Confirmar análisis estándar"
          message="¿Estás seguro de que deseas marcar este análisis como estándar? Una vez marcado, no podrás cambiarlo."
          confirmText="Confirmar"
          cancelText="Cancelar"
          (confirm)="confirmarEstandar()"
          (cancel)="cancelarEstandar()">
        </app-confirm-dialog>

        <!-- Diálogo de confirmación para Repetido -->
        <app-confirm-dialog
          [visible]="mostrarConfirmRepetido"
          title="Confirmar análisis repetido"
          message="¿Estás seguro de que deseas marcar este análisis como repetido? Una vez marcado, no podrás cambiarlo."
          confirmText="Confirmar"
          cancelText="Cancelar"
          (confirm)="confirmarRepetido()"
          (cancel)="cancelarRepetido()">
        </app-confirm-dialog>

        <div class="submit-btn">
            <button
            *ngIf="!isViewing"
            pButton
            type="submit"
            [label]="isEditing ? 'Actualizar Sanitario' : 'Crear Sanitario'"
            class="p-button-success"
            [disabled]="errores.length > 0"
            ></button>
            
            <button
            pButton
            type="button"
            (click)="onCancel()"
            [label]="isViewing ? 'Volver' : 'Cancelar'"
            class="p-button-secondary"
            style="margin-left: 10px;"
            ></button>
        </div>

      </div>    
    </form>
  </p-card>
</div>