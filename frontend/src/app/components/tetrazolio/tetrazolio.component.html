<div class="container">
  <button class="back-button" (click)="onCancel()">
    <i class="pi pi-arrow-left"></i>
    </button>
    <p-card class="card">
                <ng-template pTemplate="header">
                        <h2 class="title">
                            <ng-container *ngIf="isReadonly; else editableTitle">Ver Tetrazolio</ng-container>
                            <ng-template #editableTitle>{{ isEditing ? 'Editar Tetrazolio' : 'Crear Tetrazolio' }}</ng-template>
                        </h2>
                </ng-template>
                <form (ngSubmit)="onSubmit()" (input)="manejarProblemas()">
            <!-- Campos principales de Tetrazolio -->
            <h3>Parámetros de Tetrazolio</h3>
            <div class="form-grid">
                <!-- Cantidad de semillas (select fijo) -->
                <div class="form-field">
                    <label for="cantidadSemillas">Cantidad de semillas</label>
                    <select id="cantidadSemillas" [(ngModel)]="cantidadSemillas" name="cantidadSemillas" (change)="manejarProblemas()"
                        [ngClass]="{ 'input-error': cantidadSemillas !== null && cantidadSemillas !== undefined && cantidadSemillas < 0 }"
                        [disabled]="isReadonly" style="color: initial;">
                        <option [ngValue]="null">Seleccione...</option>
                        <option [ngValue]="25">25</option>
                        <option [ngValue]="50">50</option>
                        <option [ngValue]="100">100</option>
                    </select>
                    <span *ngIf="cantidadSemillas !== null && cantidadSemillas !== undefined && cantidadSemillas < 0" class="error-message">Se debe seleccionar un valor positivo.</span>
                </div>

                <!-- Pretratamiento: select o personalizado -->
                <div class="form-field">
                    <label for="pretratamiento">Pretratamiento</label>
                    <select id="pretratamiento" [(ngModel)]="selectedPretratamiento" name="pretratamiento" (change)="manejarProblemas()"
                        [disabled]="isReadonly" style="color: initial;">
                        <option [ngValue]="null">Seleccione...</option>
                        @for (opt of pretratamientoOptions; track $index) {
                            <option [ngValue]="opt.value">{{ opt.label }}</option>
                        }
                    </select>
                    @if (selectedPretratamiento === 'custom') {
                        <div class="custom-inline">
                            <input type="text" [(ngModel)]="pretratamientoCustom" name="pretratamientoCustom" placeholder="Especifique pretratamiento" [disabled]="isReadonly" />
                        </div>
                    }
                </div>

                <!-- Concentración: select o personalizada -->
                <div class="form-field">
                    <label for="concentracion">Concentración (%)</label>
                    <select id="concentracion" [(ngModel)]="selectedConcentracion" name="concentracion" (change)="manejarProblemas()"
                        [disabled]="isReadonly" style="color: initial;">
                        <option [ngValue]="null">Seleccione...</option>
                        @for (opt of concentracionOptions; track $index) {
                            <option [ngValue]="opt.value">{{ opt.label }}</option>
                        }
                    </select>
                    @if (selectedConcentracion === 'custom') {
                        <div class="custom-inline">
                            <input type="number" step="0.1" min="0" [(ngModel)]="concentracionCustom" name="concentracionCustom" placeholder="Especifique (%)" [ngClass]="{ 'input-error': concentracionCustom == null || (concentracionCustom != null && concentracionCustom < 0) }" [disabled]="isReadonly" />
                            <span *ngIf="selectedConcentracion === 'custom' && (concentracionCustom == null || (concentracionCustom != null && concentracionCustom < 0))" class="error-message">Se debe ingresar un valor válido.</span>
                        </div>
                    }
                </div>

                <!-- Tinción (hs): select o personalizada -->
                <div class="form-field">
                    <label for="tincionHs">Tinción (hs)</label>
                    <select id="tincionHs" [(ngModel)]="selectedTincionHs" name="tincionHs" (change)="manejarProblemas()"
                        [disabled]="isReadonly" style="color: initial;">
                        <option [ngValue]="null">Seleccione...</option>
                        @for (opt of tincionHsOptions; track $index) {
                            <option [ngValue]="opt.value">{{ opt.label }}</option>
                        }
                    </select>
                    @if (selectedTincionHs === 'custom') {
                        <div class="custom-inline">
                            <input type="number" step="0.5" min="0" [(ngModel)]="tincionHsCustom" name="tincionHsCustom" placeholder="Especifique (hs)" [ngClass]="{ 'input-error': tincionHsCustom != null && tincionHsCustom < 0 }" [disabled]="isReadonly" />
                        </div>
                    }
                </div>

                <!-- Tinción (°C): ingreso manual -->
                <div class="form-field">
                    <label for="tincionC">Tinción (°C)</label>
                    <input id="tincionC" type="number" step="0.5" [(ngModel)]="tincionC" name="tincionC" placeholder="Ingrese °C" [ngClass]="{ 'input-error': tincionC !== null && tincionC !== undefined && tincionC <= 0 }" [disabled]="isReadonly" />
                    <span *ngIf="tincionC !== null && tincionC !== undefined && tincionC <= 0" class="error-message">Se debe seleccionar un valor positivo.</span>
                </div>

                <!-- Fecha -->
                <div class="form-field">
                    <label for="fecha">Fecha</label>
                    <input id="fecha" type="date" [(ngModel)]="fecha" name="fecha"
                         [disabled]="isReadonly" />

                </div>
            </div>

            <!-- Tabla de repeticiones para Tetrazolio -->
            <h3 style="margin-top:2rem;">Tabla de repeticiones - Tetrazolio</h3>
            <div class="table-wrapper">
                <table class="p-table tetrazolio-table">
                    <thead>
                        <tr>
                            <th>Repeticion</th>
                            <th>Viables</th>
                            <th>No viables</th>
                            <th>Duras</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (rep of repeticiones; track $index) {
                        <tr>
                            <td>{{ rep.numero }}</td>
                            <td>
                                <input type="number" [ngModel]="rep.viables" (ngModelChange)="onRepeticionChange($index, 'viables', $event)" name="viables{{$index}}"
                                    [ngClass]="{ 'input-error': rep.viables !== null && rep.viables !== undefined && rep.viables < 0  }"
                                    [disabled]="isReadonly"/>
                            </td>
                            <td>
                                <input type="number" [ngModel]="rep.noViables" (ngModelChange)="onRepeticionChange($index, 'noViables', $event)" name="noViables{{$index}}"
                                    [ngClass]="{ 'input-error': rep.noViables !== null && rep.noViables !== undefined && rep.noViables < 0 }" [disabled]="isReadonly" />
                            </td>
                            <td>
                                <input type="number" [ngModel]="rep.duras" (ngModelChange)="onRepeticionChange($index, 'duras', $event)" name="duras{{$index}}"
                                    [ngClass]="{ 'input-error': rep.duras !== null && rep.duras !== undefined && rep.duras < 0 }" [disabled]="isReadonly" />
                            </td>
                            <td>
                                <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="eliminarRepeticion($index)" [disabled]="repeticiones.length === 1" title="Eliminar"></button>
                            </td>
                        </tr>

                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="footer-label">Total</td>
                            <td><input type="number" [value]="getTotalViables()" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getTotalNoViables()" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getTotalDuras()" readonly [disabled]="isReadonly" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Prom. sin redondeo</td>
                            <td><input type="number" [value]="getPromedioViables(false)" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getPromedioNoViables(false)" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getPromedioDuras(false)" readonly [disabled]="isReadonly" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Prom. redondeado</td>
                            <td><input type="number" [value]="getPromedioViables(true)" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getPromedioNoViables(true)" readonly [disabled]="isReadonly" /></td>
                            <td><input type="number" [value]="getPromedioDuras(true)" readonly [disabled]="isReadonly" /></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <button pButton type="button" label="Agregar repetición" class="btn-agregar-rep" (click)="agregarRepeticion()"></button>
            </div>
            <!-- Separador discreto entre secciones -->
            <hr class="section-divider" />

            <!-- Resumen por repetición (por tabla) -->
            <!-- Eliminado el resumen global; se muestra por cada Rn -->


            <!-- Nueva tabla de detalles de semillas -->
            <h3 style="margin-top:2.5rem;">Detalle de semillas y daños</h3>
            <div class="detalle-actions" style="margin-bottom: 0.75rem;">
                <button pButton type="button" label="Agregar Repetición" class="btn-clonar-tabla" (click)="agregarTablaDetalleClon()" [disabled]="detalles.length >= 8"></button>
                <span style="margin-left: 10px; font-size: 0.9rem; color: #666;">Tablas: {{detalles.length}} / 8</span>
            </div>

            @for (det of detalles; track $index) {
            <div class="table-wrapper">
                <div class="tabla-header-row">
                    <h4 class="tabla-titulo">R{{ $index + 1 }}</h4>
                    <div style="display:flex; gap:1rem; align-items:center; font-size:0.95rem;">
                      <span><strong>Vigor:</strong> {{ getVigorPorTabla($index) | number:'1.2-2' }} % (red: {{ getVigorPorTablaRed($index) }}%)</span>
                      <span><strong>Clasificación:</strong> {{ getClasificacionVigorPorTabla($index) }}</span>
                      <span><strong>No viables:</strong> {{ getNoViablesPorTabla($index) | number:'1.2-2' }} % {{ getNoViablesClasificadoPorTabla($index) }}</span>
                    </div>
                    @if ($index > 0) {
                    <button pButton type="button" class="btn-eliminar-tabla" icon="pi pi-trash" (click)="eliminarTablaDetalle($index)" title="Eliminar esta tabla"></button> }
                </div>
                <table class="p-table tetrazolio-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>N° de semillas</th>
                            <th>Daño mecánico</th>
                            <th>Daño ambiente</th>
                            <th>Daño chinches</th>
                            <th>Daño fracturas</th>
                            <th>Otros daños</th>
                            <th>Duras</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="footer-label">Viables sin defectos</td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.total" name="vsd_total{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.total != null && det.viablesSinDefectos.total < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.mecanico" name="vsd_mecanico{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.mecanico != null && det.viablesSinDefectos.mecanico < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.ambiente" name="vsd_ambiente{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.ambiente != null && det.viablesSinDefectos.ambiente < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.chinches" name="vsd_chinches{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.chinches != null && det.viablesSinDefectos.chinches < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.fracturas" name="vsd_fracturas{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.fracturas != null && det.viablesSinDefectos.fracturas < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.otros" name="vsd_otros{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.otros != null && det.viablesSinDefectos.otros < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSinDefectos.duras" name="vsd_duras{{$index}}" [ngClass]="{ 'input-error': det.viablesSinDefectos.duras != null && det.viablesSinDefectos.duras < 0 }" [disabled]="isReadonly"/></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Viables defectos leves</td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.total" name="vl_total{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.total != null && det.viablesLeves.total < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.mecanico" name="vl_mecanico{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.mecanico != null && det.viablesLeves.mecanico < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.ambiente" name="vl_ambiente{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.ambiente != null && det.viablesLeves.ambiente < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.chinches" name="vl_chinches{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.chinches != null && det.viablesLeves.chinches < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.fracturas" name="vl_fracturas{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.fracturas != null && det.viablesLeves.fracturas < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.otros" name="vl_otros{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.otros != null && det.viablesLeves.otros < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesLeves.duras" name="vl_duras{{$index}}" [ngClass]="{ 'input-error': det.viablesLeves.duras != null && det.viablesLeves.duras < 0 }" [disabled]="isReadonly"/></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Viables defectos moderados</td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.total" name="vm_total{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.total != null && det.viablesModerados.total < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.mecanico" name="vm_mecanico{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.mecanico != null && det.viablesModerados.mecanico < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.ambiente" name="vm_ambiente{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.ambiente != null && det.viablesModerados.ambiente < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.chinches" name="vm_chinches{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.chinches != null && det.viablesModerados.chinches < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.fracturas" name="vm_fracturas{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.fracturas != null && det.viablesModerados.fracturas < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.otros" name="vm_otros{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.otros != null && det.viablesModerados.otros < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesModerados.duras" name="vm_duras{{$index}}" [ngClass]="{ 'input-error': det.viablesModerados.duras != null && det.viablesModerados.duras < 0 }" [disabled]="isReadonly"/></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Viables defectos severos</td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.total" name="vs_total{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.total != null && det.viablesSeveros.total < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.mecanico" name="vs_mecanico{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.mecanico != null && det.viablesSeveros.mecanico < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.ambiente" name="vs_ambiente{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.ambiente != null && det.viablesSeveros.ambiente < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.chinches" name="vs_chinches{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.chinches != null && det.viablesSeveros.chinches < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.fracturas" name="vs_fracturas{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.fracturas != null && det.viablesSeveros.fracturas < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.otros" name="vs_otros{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.otros != null && det.viablesSeveros.otros < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.viablesSeveros.duras" name="vs_duras{{$index}}" [ngClass]="{ 'input-error': det.viablesSeveros.duras != null && det.viablesSeveros.duras < 0 }" [disabled]="isReadonly"/></td>
                        </tr>
                        <tr>
                            <td class="footer-label">No viables</td>
                            <td><input type="number" [(ngModel)]="det.noViables.total" name="nv_total{{$index}}" [ngClass]="{ 'input-error': det.noViables.total != null && det.noViables.total < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.noViables.mecanico" name="nv_mecanico{{$index}}" [ngClass]="{ 'input-error': det.noViables.mecanico != null && det.noViables.mecanico < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.noViables.ambiente" name="nv_ambiente{{$index}}" [ngClass]="{ 'input-error': det.noViables.ambiente != null && det.noViables.ambiente < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.noViables.chinches" name="nv_chinches{{$index}}" [ngClass]="{ 'input-error': det.noViables.chinches != null && det.noViables.chinches < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.noViables.fracturas" name="nv_fracturas{{$index}}" [ngClass]="{ 'input-error': det.noViables.fracturas != null && det.noViables.fracturas < 0 }" [disabled]="isReadonly" /></td>
                            <td><input type="number" [(ngModel)]="det.noViables.otros" name="nv_otros{{$index}}" [ngClass]="{ 'input-error': det.noViables.otros != null && det.noViables.otros < 0 }" [disabled]="isReadonly"/></td>
                            <td><input type="number" [(ngModel)]="det.noViables.duras" name="nv_duras{{$index}}" [ngClass]="{ 'input-error': det.noViables.duras != null && det.noViables.duras < 0 }" [disabled]="isReadonly" /></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Semillas viables</td>
                            <td><input type="number" [value]="getSemillasViablesTotal(det)" readonly /></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'mecanico')" readonly [disabled]="isReadonly"/></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'ambiente')" readonly [disabled]="isReadonly"/></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'chinches')" readonly [disabled]="isReadonly"/></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'fracturas')" readonly [disabled]="isReadonly"/></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'otros')" readonly [disabled]="isReadonly"/></td>
                            <td><input type="number" [value]="getSemillasViables(det, 'duras')" readonly [disabled]="isReadonly"/></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Suma</td>
                            <td><input type="number" [value]="getSumaTotal(det)" readonly [disabled]="isReadonly"/></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            }

            <!-- Separador discreto entre secciones -->
            <hr class="section-divider" />

            <!-- Tabla de Reporte -->
            <h3 style="margin-top:2.5rem;">Reporte</h3>
            <div class="table-wrapper">
                <table class="p-table tetrazolio-table reporte-table">
                    <thead>
                        <tr>
                            <th colspan="2" class="reporte-header">REPORTE</th>
                            <th colspan="7" class="reporte-header">Deberia salir asi en %</th>
                        </tr>
                        <tr>
                            <th class="reporte-subheader">Viabilidad y Vigor por tetrazolio</th>
                            <th class="reporte-subheader">%</th>
                            <th colspan="7" class="reporte-subheader">Daños %</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>Mecánicos</th>
                            <th>Ambiente</th>
                            <th>Chinches</th>
                            <th>Fracturas</th>
                            <th>Otros</th>
                            <th>Duras</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="footer-label">Vigor Alto</td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.porcentaje" (ngModelChange)="actualizarCalculosReporte()" name="reporte_vigorAlto_porcentaje" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.porcentaje != null && (reporte.vigorAlto.porcentaje < 0 || reporte.vigorAlto.porcentaje > 100) }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.mecanicos" name="reporte_vigorAlto_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.mecanicos != null && reporte.vigorAlto.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.ambiente" name="reporte_vigorAlto_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.ambiente != null && reporte.vigorAlto.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.chinches" name="reporte_vigorAlto_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.chinches != null && reporte.vigorAlto.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.fracturas" name="reporte_vigorAlto_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.fracturas != null && reporte.vigorAlto.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.otros" name="reporte_vigorAlto_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.otros != null && reporte.vigorAlto.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAlto.danios.duras" name="reporte_vigorAlto_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAlto.danios.duras != null && reporte.vigorAlto.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Vigor Medio</td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.porcentaje" (ngModelChange)="actualizarCalculosReporte()" name="reporte_vigorMedio_porcentaje" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.porcentaje != null && (reporte.vigorMedio.porcentaje < 0 || reporte.vigorMedio.porcentaje > 100) }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.mecanicos" name="reporte_vigorMedio_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.mecanicos != null && reporte.vigorMedio.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.ambiente" name="reporte_vigorMedio_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.ambiente != null && reporte.vigorMedio.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.chinches" name="reporte_vigorMedio_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.chinches != null && reporte.vigorMedio.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.fracturas" name="reporte_vigorMedio_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.fracturas != null && reporte.vigorMedio.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.otros" name="reporte_vigorMedio_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.otros != null && reporte.vigorMedio.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorMedio.danios.duras" name="reporte_vigorMedio_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorMedio.danios.duras != null && reporte.vigorMedio.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Vigor Bajo</td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.porcentaje" (ngModelChange)="actualizarCalculosReporte()" name="reporte_vigorBajo_porcentaje" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.porcentaje != null && (reporte.vigorBajo.porcentaje < 0 || reporte.vigorBajo.porcentaje > 100) }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.mecanicos" name="reporte_vigorBajo_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.mecanicos != null && reporte.vigorBajo.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.ambiente" name="reporte_vigorBajo_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.ambiente != null && reporte.vigorBajo.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.chinches" name="reporte_vigorBajo_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.chinches != null && reporte.vigorBajo.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.fracturas" name="reporte_vigorBajo_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.fracturas != null && reporte.vigorBajo.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.otros" name="reporte_vigorBajo_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.otros != null && reporte.vigorBajo.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorBajo.danios.duras" name="reporte_vigorBajo_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorBajo.danios.duras != null && reporte.vigorBajo.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Limite Crítico</td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.porcentaje" name="reporte_limiteCritico_porcentaje" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.porcentaje != null && (reporte.limiteCritico.porcentaje < 0 || reporte.limiteCritico.porcentaje > 100) }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.mecanicos" name="reporte_limiteCritico_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.mecanicos != null && reporte.limiteCritico.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.ambiente" name="reporte_limiteCritico_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.ambiente != null && reporte.limiteCritico.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.chinches" name="reporte_limiteCritico_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.chinches != null && reporte.limiteCritico.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.fracturas" name="reporte_limiteCritico_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.fracturas != null && reporte.limiteCritico.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.otros" name="reporte_limiteCritico_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.otros != null && reporte.limiteCritico.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.limiteCritico.danios.duras" name="reporte_limiteCritico_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.limiteCritico.danios.duras != null && reporte.limiteCritico.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">No viables</td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.porcentaje" name="reporte_noViables_porcentaje" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.porcentaje != null && (reporte.noViables.porcentaje < 0 || reporte.noViables.porcentaje > 100) }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.mecanicos" name="reporte_noViables_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.mecanicos != null && reporte.noViables.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.ambiente" name="reporte_noViables_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.ambiente != null && reporte.noViables.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.chinches" name="reporte_noViables_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.chinches != null && reporte.noViables.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.fracturas" name="reporte_noViables_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.fracturas != null && reporte.noViables.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.otros" name="reporte_noViables_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.otros != null && reporte.noViables.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.noViables.danios.duras" name="reporte_noViables_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.noViables.danios.duras != null && reporte.noViables.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Viabilidad</td>
                            <td><input type="number" step="0.1" [value]="getViabilidadReportePct()" name="reporte_viabilidad_porcentaje" readonly /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.mecanicos" name="reporte_viabilidad_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.mecanicos != null && reporte.viabilidad.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.ambiente" name="reporte_viabilidad_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.ambiente != null && reporte.viabilidad.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.chinches" name="reporte_viabilidad_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.chinches != null && reporte.viabilidad.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.fracturas" name="reporte_viabilidad_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.fracturas != null && reporte.viabilidad.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.otros" name="reporte_viabilidad_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.otros != null && reporte.viabilidad.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.viabilidad.danios.duras" name="reporte_viabilidad_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.viabilidad.danios.duras != null && reporte.viabilidad.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="footer-label">Vigor Acumulado</td>
                            <td><input type="number" step="0.1" [value]="getVigorAcumuladoReportePct()" name="reporte_vigorAcumulado_porcentaje" readonly /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.mecanicos" name="reporte_vigorAcumulado_mecanicos" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.mecanicos != null && reporte.vigorAcumulado.danios.mecanicos < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.ambiente" name="reporte_vigorAcumulado_ambiente" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.ambiente != null && reporte.vigorAcumulado.danios.ambiente < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.chinches" name="reporte_vigorAcumulado_chinches" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.chinches != null && reporte.vigorAcumulado.danios.chinches < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.fracturas" name="reporte_vigorAcumulado_fracturas" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.fracturas != null && reporte.vigorAcumulado.danios.fracturas < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.otros" name="reporte_vigorAcumulado_otros" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.otros != null && reporte.vigorAcumulado.danios.otros < 0 }" /></td>
                            <td><input type="number" step="0.1" [(ngModel)]="reporte.vigorAcumulado.danios.duras" name="reporte_vigorAcumulado_duras" [disabled]="isReadonly" [ngClass]="{ 'input-error': reporte.vigorAcumulado.danios.duras != null && reporte.vigorAcumulado.danios.duras < 0 }" /></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <<!-- Checkboxes - visible solo para admin al editar -->
                <div class="checkbox-container" *ngIf="isEditing && isAdmin">
                    <h4 class="checkbox-title">Opciones De Edición</h4>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="repetido-checkbox" [(ngModel)]="repetido" (change)="onRepetidoChange()" name="repetido" class="custom-checkbox" [disabled]="isReadonly || repetidoDeshabilitado" />
                            <label for="repetido-checkbox" class="checkbox-label">
                                <span class="checkmark"></span>
                                <span class="checkbox-text">Repetir</span>
                            </label>
                        </div>

                        <div class="checkbox-item">
                            <input type="checkbox" id="estandar-checkbox" [(ngModel)]="estandar" (change)="onEstandarChange()" name="estandar" class="custom-checkbox" [disabled]="isReadonly || estandarDeshabilitado" />
                            <label for="estandar-checkbox" class="checkbox-label">
                                <span class="checkmark"></span>
                                <span class="checkbox-text">Estándar</span>
                            </label>
                        </div>
                    </div>
                </div>


             <!-- Mensajes de error -->
            <div *ngIf="errores && errores.length > 0" class="error-container">
                <p class="error-message">
                    {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
                </p>
                <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
            </div>


            <div class="submit-btn" style="margin-top: 1.2rem;">
                <button *ngIf="!isReadonly" pButton type="submit" class="p-button-success" [disabled]="errores.length > 0 || isSubmitting">
                    <i *ngIf="isSubmitting" class="pi pi-spin pi-spinner" style="margin-right: 8px;"></i>
                    {{ isSubmitting ? 'Procesando...' : (isEditing ? 'Editar Tetrazolio' : 'Crear Tetrazolio') }}
                </button>

                <button pButton type="button" (click)="onCancel()" label="{{ isReadonly ? 'Volver' : 'Cancelar' }}" class="p-button-secondary" style="margin-left: 10px;" [disabled]="isSubmitting"></button>
            </div>

        </form>
    </p-card>
</div>
