<div class="container">
  <p-card class="card">
    <ng-template pTemplate="header">
  <h2 class="title">{{ isEditing ? 'Editar Tetrazolio' : 'Crear Tetrazolio' }}</h2>
    </ng-template>
    <form>
      <!-- Campos principales de Tetrazolio -->
      <h3>Parámetros de Tetrazolio</h3>
      <div class="form-grid">
        <!-- Cantidad de semillas (select fijo) -->
        <div class="form-field">
          <label for="cantidadSemillas">Cantidad de semillas</label>
          <select id="cantidadSemillas" [(ngModel)]="cantidadSemillas" name="cantidadSemillas">
            <option [ngValue]="null">Seleccione...</option>
            <option [ngValue]="25">25</option>
            <option [ngValue]="50">50</option>
            <option [ngValue]="100">100</option>
          </select>
        </div>

        <!-- Pretratamiento: select o personalizado -->
        <div class="form-field">
          <label for="pretratamiento">Pretratamiento</label>
          <select id="pretratamiento" [(ngModel)]="selectedPretratamiento" name="pretratamiento">
            <option [ngValue]="null">Seleccione...</option>
            @for (opt of pretratamientoOptions; track $index) {
              <option [ngValue]="opt.value">{{ opt.label }}</option>
            }
          </select>
          @if (selectedPretratamiento === 'custom') {
            <div class="custom-inline">
              <input type="text" [(ngModel)]="pretratamientoCustom" name="pretratamientoCustom" placeholder="Especifique pretratamiento" />
            </div>
          }
        </div>

        <!-- Concentración: select o personalizada -->
        <div class="form-field">
          <label for="concentracion">Concentración (%)</label>
          <select id="concentracion" [(ngModel)]="selectedConcentracion" name="concentracion">
            <option [ngValue]="null">Seleccione...</option>
            @for (opt of concentracionOptions; track $index) {
              <option [ngValue]="opt.value">{{ opt.label }}</option>
            }
          </select>
          @if (selectedConcentracion === 'custom') {
            <div class="custom-inline">
              <input type="number" step="0.1" min="0" [(ngModel)]="concentracionCustom" name="concentracionCustom" placeholder="Especifique (%)" />
            </div>
          }
        </div>

        <!-- Tinción (hs): select o personalizada -->
        <div class="form-field">
          <label for="tincionHs">Tinción (hs)</label>
          <select id="tincionHs" [(ngModel)]="selectedTincionHs" name="tincionHs">
            <option [ngValue]="null">Seleccione...</option>
            @for (opt of tincionHsOptions; track $index) {
              <option [ngValue]="opt.value">{{ opt.label }}</option>
            }
          </select>
          @if (selectedTincionHs === 'custom') {
            <div class="custom-inline">
              <input type="number" step="0.5" min="0" [(ngModel)]="tincionHsCustom" name="tincionHsCustom" placeholder="Especifique (hs)" />
            </div>
          }
        </div>

        <!-- Tinción (°C): ingreso manual -->
        <div class="form-field">
          <label for="tincionC">Tinción (°C)</label>
          <input id="tincionC" type="number" step="0.5" [(ngModel)]="tincionC" name="tincionC" placeholder="Ingrese °C" />
        </div>

        <!-- Fecha -->
        <div class="form-field">
          <label for="fecha">Fecha</label>
          <input id="fecha" type="date" [(ngModel)]="fecha" name="fecha" />
        </div>
      </div>

      <!-- Tabla de repeticiones para Tetrazolio -->
      <h3 style="margin-top:2rem;">Tabla de repeticiones - Tetrazolio</h3>
      <div class="table-wrapper">
        <table class="p-table tetrazolio-table">
          <thead>
            <tr>
              <th>Repeticion</th>
              <th>Viables</th>
              <th>No viables</th>
              <th>Duras</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (rep of repeticiones; track $index) {
            <tr>
              <td>{{ rep.numero }}</td>
              <td><input type="number" [(ngModel)]="rep.viables" name="viables{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="rep.noViables" name="noViables{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="rep.duras" name="duras{{$index}}" /></td>
              <td>
                <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="eliminarRepeticion($index)" [disabled]="repeticiones.length === 1" title="Eliminar"></button>
              </td>
            </tr>
            }
          </tbody>
          <tfoot>
            <tr>
              <td class="footer-label">Total</td>
              <td><input type="number" [value]="getTotalViables()" readonly /></td>
              <td><input type="number" [value]="getTotalNoViables()" readonly /></td>
              <td><input type="number" [value]="getTotalDuras()" readonly /></td>
              <td></td>
            </tr>
            <tr>
              <td class="footer-label">Prom. redondeado</td>
              <td><input type="number" [value]="getPromedioViables(true)" readonly /></td>
              <td><input type="number" [value]="getPromedioNoViables(true)" readonly /></td>
              <td><input type="number" [value]="getPromedioDuras(true)" readonly /></td>
              <td></td>
            </tr>
            <tr>
              <td class="footer-label">Prom. sin redondeo</td>
              <td><input type="number" [value]="getPromedioViables(false)" readonly /></td>
              <td><input type="number" [value]="getPromedioNoViables(false)" readonly /></td>
              <td><input type="number" [value]="getPromedioDuras(false)" readonly /></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        <button pButton type="button" label="Agregar repetición" class="btn-agregar-rep" (click)="agregarRepeticion()"></button>
      </div>
      <!-- Separador discreto entre secciones -->
      <hr class="section-divider" />


      <!-- Nueva tabla de detalles de semillas -->
      <h3 style="margin-top:2.5rem;">Detalle de semillas y daños</h3>
      <div class="detalle-actions" style="margin-bottom: 0.75rem;">
        <button pButton type="button" label="Clonar tabla" icon="pi pi-copy" class="btn-clonar-tabla" (click)="agregarTablaDetalleClon()" [disabled]="detalles.length >= 8"></button>
        <span style="margin-left: 10px; font-size: 0.9rem; color: #666;">Tablas: {{detalles.length}} / 8</span>
      </div>

      @for (det of detalles; track $index) {
      <div class="table-wrapper">
        <div class="tabla-header-row">
          <h4 class="tabla-titulo">R{{ $index + 1 }}</h4>
          @if ($index > 0) {
            <button pButton type="button" class="btn-eliminar-tabla" icon="pi pi-trash" (click)="eliminarTablaDetalle($index)" title="Eliminar esta tabla"></button>
          }
        </div>
        <table class="p-table tetrazolio-table">
          <thead>
            <tr>
              <th></th>
              <th>N° de semillas</th>
              <th>Daño mecánico</th>
              <th>Daño ambiente</th>
              <th>Daño chinches</th>
              <th>Daño fracturas</th>
              <th>Otros daños</th>
              <th>Duras</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="footer-label">Viables sin defectos</td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.total" name="vsd_total{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.mecanico" name="vsd_mecanico{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.ambiente" name="vsd_ambiente{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.chinches" name="vsd_chinches{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.fracturas" name="vsd_fracturas{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.otros" name="vsd_otros{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSinDefectos.duras" name="vsd_duras{{$index}}" /></td>
            </tr>
            <tr>
              <td class="footer-label">Viables defectos leves</td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.total" name="vl_total{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.mecanico" name="vl_mecanico{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.ambiente" name="vl_ambiente{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.chinches" name="vl_chinches{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.fracturas" name="vl_fracturas{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.otros" name="vl_otros{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesLeves.duras" name="vl_duras{{$index}}" /></td>
            </tr>
            <tr>
              <td class="footer-label">Viables defectos moderados</td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.total" name="vm_total{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.mecanico" name="vm_mecanico{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.ambiente" name="vm_ambiente{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.chinches" name="vm_chinches{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.fracturas" name="vm_fracturas{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.otros" name="vm_otros{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesModerados.duras" name="vm_duras{{$index}}" /></td>
            </tr>
            <tr>
              <td class="footer-label">Viables defectos severos</td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.total" name="vs_total{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.mecanico" name="vs_mecanico{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.ambiente" name="vs_ambiente{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.chinches" name="vs_chinches{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.fracturas" name="vs_fracturas{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.otros" name="vs_otros{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.viablesSeveros.duras" name="vs_duras{{$index}}" /></td>
            </tr>
            <tr>
              <td class="footer-label">No viables</td>
              <td><input type="number" [(ngModel)]="det.noViables.total" name="nv_total{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.mecanico" name="nv_mecanico{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.ambiente" name="nv_ambiente{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.chinches" name="nv_chinches{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.fracturas" name="nv_fracturas{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.otros" name="nv_otros{{$index}}" /></td>
              <td><input type="number" [(ngModel)]="det.noViables.duras" name="nv_duras{{$index}}" /></td>
            </tr>
            <tr>
              <td class="footer-label">Semillas viables</td>
              <td><input type="number" [value]="getSemillasViablesTotal(det)" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'mecanico')" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'ambiente')" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'chinches')" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'fracturas')" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'otros')" readonly /></td>
              <td><input type="number" [value]="getSemillasViables(det, 'duras')" readonly /></td>
            </tr>
            <tr>
              <td class="footer-label">Suma</td>
              <td><input type="number" [value]="getSumaTotal(det)" readonly /></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
      }

      <!-- Checkbox Repetido - solo visible al editar -->
      @if (isEditing) {
        <div class="form-field">
          <label>
            <span>Repetir</span>
            <input 
              type="checkbox" 
              [(ngModel)]="repetido" 
              name="repetido"
            />
          </label>
        </div>
      }

      <div class="submit-btn" style="margin-top: 1.2rem;">
        <button
          pButton
          type="button"
          (click)="onSubmit()"
          [label]="isEditing ? 'Actualizar Tetrazolio' : 'Crear Tetrazolio'"
          class="p-button-success"
        ></button>
        
        <button
          pButton
          type="button"
          (click)="onCancel()"
          label="Cancelar"
          class="p-button-secondary"
          style="margin-left: 10px;"
        ></button>
      </div>

    </form>
  </p-card>
</div>


