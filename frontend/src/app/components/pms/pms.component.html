<div class="container">
  <!-- Botón de navegación hacia atrás -->
  <button class="back-button" (click)="onCancel()">
    <i class="pi pi-arrow-left"></i>
  </button>
  
  <p-card class="card">
    <ng-template pTemplate="header">
      <h2 class="title">{{ isViewing ? 'Ver PMS' : (isEditing ? 'Editar PMS' : 'Crear PMS') }}</h2>
    </ng-template>

    <form (ngSubmit)="onSubmit()" (input)="manejarProblemas();">
      

      <div class="table-section">
        <h3 class="table-title">Tabla de repeticiones - PMS</h3>
        <div class="table-wrapper">
          <table class="p-table">
            <thead>
              <tr>
                <th>Repetición</th>
                <th>Gramos</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="repeticiones.length === 0">
                <td [attr.colspan]="isViewing ? 2 : 3" class="no-repeticiones">
                  No hay repeticiones agregadas. Haz clic en "Agregar repetición" para comenzar.
                </td>
              </tr>
              <tr *ngFor="let rep of repeticiones; let i = index">
                <td>{{ rep.numero }}</td>
                <td>
                  <div class="gramos-cell">
                    <input
                      type="number"
                      [value]="rep.gramos"
                      (input)="onGramosChange(i, $event.target.value)"
                      [name]="'gramos' + i"
                      step="0.0001"
                      [readonly]="isReadonly"
                      [ngClass]="{ 'input-error': repeticiones[i].gramos != null && repeticiones[i].gramos < 0 }"/>
                    
                    <span *ngIf="repeticiones[i].gramos != null && repeticiones[i].gramos < 0" class="error-message">La incidencia debe ser mayor a 0.</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

       <!-- Alerta de Coeficiente de Variación -->
      <div *ngIf="debeAlertarCV" class="alert-cv">
        <i class="pi pi-exclamation-triangle"></i>
        <span>El coeficiente de variación supera el umbral de {{ CV_UMBRAL }}%. Se han expandido automáticamente a 16 repeticiones.</span>
      </div>

      <div class="form-grid">
        <!-- Campos de texto -->

        <div class="form-field">
          <label for="pesoPromedioCienSemillas">Peso Promedio Cien Semillas</label>
          <input id="pesoPromedioCienSemillas" type="number" [value]="promedioCienSemillas()" name="pesoPromedioCienSemillas" pInputText step="0.0001" [readonly]="true" 
                 [ngClass]="{ 'input-error': (promedioCienSemillas() ?? 0) < 0 }"/>
          <span *ngIf="(promedioCienSemillas() ?? 0) < 0" class="error-message">El valor no puede ser negativo.</span>
        </div>


        <div class="form-field">
          <label for="pesoMilSemillas">Peso Mil Semillas</label>
          <input id="pesoMilSemillas" type="number" [(ngModel)]="pesoMilSemillas" name="pesoMilSemillas" pInputText step="0.0001" [readonly]="isReadonly" 
                 [ngClass]="{ 'input-error': pesoMilSemillas != null && pesoMilSemillas < 0 }"/>
          <span *ngIf="pesoMilSemillas != null && pesoMilSemillas < 0" class="error-message">El valor no puede ser negativo.</span>
        </div>

        
        <div class="form-field">
          <label for="pesoPromedioMilSemillas">Peso Promedio Mil Semillas</label>
          <input id="pesoPromedioMilSemillas" type="number" [(ngModel)]="pesoPromedioMilSemillas" name="pesoPromedioMilSemillas" pInputText step="0.0001" [readonly]="isReadonly" 
                 [ngClass]="{ 'input-error': pesoPromedioMilSemillas != null && pesoPromedioMilSemillas < 0 }"/>
          <span *ngIf="pesoPromedioMilSemillas != null && pesoPromedioMilSemillas < 0" class="error-message">El valor no puede ser negativo.</span>
        </div>

        <div class="form-field">
          <label ñfor="desvioEstandar">Desvío Estándar</label>
          <input id="desvioEstandar" type="number" [value]="calcularDesvioEstandar()" name="desvioEstandar" pInputText step="0.0001" [readonly]="true" 
                 [ngClass]="{ 'input-error': (calcularDesvioEstandar() ?? 0) < 0 }"/>
          <span *ngIf="(calcularDesvioEstandar() ?? 0) < 0" class="error-message">El valor no puede ser negativo.</span>
        </div>

        <div class="form-field">
          <label for="coeficienteVariacion">Coeficiente de Variación (%)</label>
          <input id="coeficienteVariacion" type="number" [value]="calcularCoeficienteVariacion()" name="coeficienteVariacion" pInputText step="0.0001" [readonly]="true" 
                 [ngClass]="{ 'input-error': (calcularCoeficienteVariacion() ?? 0) < 0 }"/>
          <span *ngIf="(calcularCoeficienteVariacion() ?? 0) < 0" class="error-message">El valor no puede ser negativo.</span>
        </div>

        <div class="form-field">
          <label for="fechaMedicion">Fecha Medicion</label>
          <input id="fechaMedicion" type="date" [(ngModel)]="fechaMedicion" name="fechaMedicion" pInputText [readonly]="isReadonly" 
                 [ngClass]="{ 'input-error': validarFecha(fechaMedicion) }"/>
          <span *ngIf="validarFecha(fechaMedicion)" class="error-message">La fecha no puede ser futura.</span>
        </div>

        <div class="form-field">
          <label for="comentarios">Comentarios</label>
          <textarea
            id="comentarios"
            rows="3"
            [(ngModel)]="comentarios"
            name="comentarios"
            [readonly]="isReadonly"
          ></textarea>
        </div>

        <!-- Checkboxes - visible solo para admin al editar -->
        <div class="checkbox-container" *ngIf="isEditing && isAdmin">
          <h4 class="checkbox-title">Opciones De Edición</h4>
          <div class="checkbox-grid">
            <div class="checkbox-item">
              <input 
                type="checkbox" 
                id="repetido-checkbox"
                [(ngModel)]="repetido" 
                (change)="onRepetidoChange()"
                name="repetido"
                class="custom-checkbox"
                [disabled]="isReadonly || repetidoDeshabilitado"
              />
              <label for="repetido-checkbox" class="checkbox-label">
                <span class="checkmark"></span>
                <span class="checkbox-text">Repetir</span>
              </label>
            </div>
            
            <div class="checkbox-item">
              <input 
                type="checkbox" 
                id="estandar-checkbox"
                [(ngModel)]="estandar" 
                (change)="onEstandarChange()"
                name="estandar"
                class="custom-checkbox"
                [disabled]="isReadonly || estandarDeshabilitado"
              />
              <label for="estandar-checkbox" class="checkbox-label">
                <span class="checkmark"></span>
                <span class="checkbox-text">Estándar</span>
              </label>
            </div>
          </div>
        </div>

      </div>

      <!-- Diálogo de confirmación para Estándar -->
      <app-confirm-dialog
        [visible]="mostrarConfirmEstandar"
        title="Confirmar análisis estándar"
        message="¿Estás seguro de que deseas marcar este análisis como estándar? Una vez marcado, no podrás cambiarlo."
        confirmText="Confirmar"
        cancelText="Cancelar"
        (confirm)="confirmarEstandar()"
        (cancel)="cancelarEstandar()">
      </app-confirm-dialog>

      <!-- Diálogo de confirmación para Repetido -->
      <app-confirm-dialog
        [visible]="mostrarConfirmRepetido"
        title="Confirmar análisis repetido"
        message="¿Estás seguro de que deseas marcar este análisis como repetido? Una vez marcado, no podrás cambiarlo."
        confirmText="Confirmar"
        cancelText="Cancelar"
        (confirm)="confirmarRepetido()"
        (cancel)="cancelarRepetido()">
      </app-confirm-dialog>

      <div *ngIf="errores.length > 0" class="error-container">
        <p class="error-message">
          {{ errores.length === 1 ? '1 error encontrado' : errores.length + ' errores encontrados' }}
        </p>
        <p *ngFor="let error of errores" class="error-message">{{ error }}</p>
      </div>

      <div class="submit-btn">
        <button
          *ngIf="!isViewing"
          pButton
          type="submit"
          [label]="isEditing ? 'Actualizar PMS' : 'Crear PMS'"
          class="p-button-success"
          [disabled]="errores.length > 0"
        ></button>
        <button
          pButton
          type="button"
          [label]="isViewing ? 'Volver' : 'Cancelar'"
          class="p-button-secondary"
          (click)="onCancel()"
        ></button>
      </div>
    </form>
  </p-card>
</div>
